<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Concept Word Problems Practice</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #fdfdff;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .controls-container {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .controls-container button {
            padding: 10px 20px;
            font-size: 1em;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 10px;
        }
        #generateTestButton { background-color: #007bff; }
        #generateTestButton:hover { background-color: #0056b3; }
        #showSolutionsButton { background-color: #28a745; }
        #showSolutionsButton:hover { background-color: #218838; }
        #showSolutionsButton:disabled {
            background-color: #6c757d; /* Gray when disabled */
            cursor: not-allowed;
        }

        .problem-list {
            list-style-type: none;
            padding-left: 0;
        }
        .problem-list li {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }
        .problem-number {
            font-weight: bold;
            margin-right: 10px;
            font-size: 1.1em;
        }
        .problem-text-container {
            font-family: 'Georgia', serif;
            font-size: 1.1em;
            color: #444;
            display: block;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .answer-space {
            display: block;
            margin-top: 10px;
            font-style: italic;
            color: #777;
        }
        .problem-list li.solutions-shown .problem-text-container,
        .problem-list li.solutions-shown .answer-space,
        .problem-list li.solutions-shown .problem-number {
            /* color: #aaa; Optional: Keep full color if preferred */
        }

        sup, sub {
            line-height: 0;
        }
        .fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            margin: 0 0.2em;
            position: relative;
        }
        .fraction .numerator, .fraction .denominator {
            display: block;
            padding: 0 0.3em;
            line-height: 1.2;
        }
        .fraction .numerator {
            border-bottom: 1.5px solid black;
        }

        .solution-steps {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #e9f5ff; /* Light blue background */
            border: 1px dashed #5bc0de; /* Info blue border */
            border-radius: 4px;
            font-family: 'Arial', sans-serif; /* Clear font for solutions */
            font-size: 1.0em;
            line-height: 1.5;
        }
        .solution-steps p {
            margin: 8px 0;
            word-wrap: break-word;
        }
        .solution-steps .final-answer {
            font-weight: bold;
            color: #007bff; /* Primary blue for final answer */
            margin-top:10px;
            padding-top:5px;
            border-top: 1px solid #ccc;
        }
        .highlight-op {
            color: #d9534f;
            font-weight: bold;
            background-color: #f9e6e5;
            padding: 0 2px;
            border-radius: 2px;
        }

        @media print {
            body { margin: 0.5in; }
            .controls-container { display: none; }
            h1 { font-size: 18pt; }
            .problem-list li { page-break-inside: avoid; }
             .problem-list li.solutions-shown .problem-text-container,
            .problem-list li.solutions-shown .answer-space,
            .problem-list li.solutions-shown .problem-number {
                 color: #444 !important; /* Keep original color for print */
            }
            .solution-steps {
                background-color: #fff !important;
                border: 1px solid #ccc !important;
            }
        }
    </style>
</head>
<body>

    <h1>Multi-Concept Word Problems Practice</h1>

    <div class="controls-container">
        <button id="generateTestButton">Generate New Test</button>
        <button id="showSolutionsButton">Show Solutions</button>
    </div>

    <ol class="problem-list" id="problemListContainer">
        <!-- Problems will be dynamically inserted here -->
    </ol>

    <script>
        const problemListContainer = document.getElementById('problemListContainer');
        const showSolutionsBtn = document.getElementById('showSolutionsButton');
        const generateTestBtn = document.getElementById('generateTestButton');
        let currentProblemsData = [];

        // --- Helper Functions ---
        function getRandomInt(min, max) {
            if (min > max) { // Ensure min <= max
                // console.warn(`getRandomInt: min (${min}) was greater than max (${max}). Swapping them.`);
                [min, max] = [max, min];
            }
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function gcd(a, b) {
            a = Math.abs(a);
            b = Math.abs(b);
            if (b === 0) return a;
            return gcd(b, a % b);
        }

        function simplifyFraction(numerator, denominator) {
            if (denominator === 0) return { num: numerator, den: denominator }; // Avoid division by zero
            const commonDivisor = gcd(numerator, denominator);
            let num = numerator / commonDivisor;
            let den = denominator / commonDivisor;
            if (den < 0) { // Ensure denominator is positive
                num = -num;
                den = -den;
            }
            return { num, den };
        }
        
        function formatDecimal(value, places = 2) {
            if (!isFinite(value) || typeof value !== 'number') { // Handle Infinity, -Infinity, NaN, and non-numbers
                return String(value); // Or "N/A", "Error", etc.
            }
            if (Number.isInteger(value)) return value.toString();
            // Check if it's very close to an integer due to floating point issues
            if (Math.abs(value - Math.round(value)) < 1e-9) {
                 return Math.round(value).toString();
            }
            return value.toFixed(places);
        }

        function formatFractionHTML(num, den, simplifyResult = true) { // Changed default for simplify
            if (den === 0) return "Error: Div by 0";
            if (simplifyResult) {
                const simplified = simplifyFraction(num, den);
                num = simplified.num;
                den = simplified.den;
            }
            if (den === 1) return `${num}`;
            if (num === 0) return `0`; // simplify 0/den to 0
            return `<span class="fraction"><span class="numerator">${num}</span><span class="denominator">${den}</span></span>`;
        }


        // --- Problem Generator Functions ---
        const problemGenerators = [
            // Problem 1: Tank filling with leak
            function generateTankProblem() {
                const initialFractionDen = getRandomInt(3, 5);
                const initialFractionNum = getRandomInt(1, initialFractionDen - 1);
                const pumpRate = getRandomInt(8, 20);
                const leakRate = getRandomInt(1, Math.max(1, Math.floor(pumpRate * 0.6))); 
                const totalCapacity = getRandomInt(10, 30) * 10; 

                const initialWater = (initialFractionNum / initialFractionDen) * totalCapacity;
                const remainingVolume = totalCapacity - initialWater;
                const netFillingRate = pumpRate - leakRate;
                let timeToFill = 0;
                if (netFillingRate <= 0) { 
                    timeToFill = Infinity; 
                } else {
                    timeToFill = remainingVolume / netFillingRate;
                }
                
                const problemText = `A tank is ${formatFractionHTML(initialFractionNum, initialFractionDen)} full of water. A pump starts filling it at a rate of ${pumpRate} liters per minute. However, there is a leak in the tank that drains water at a rate of ${leakRate} liters per minute. If the total capacity of the tank is ${totalCapacity} liters, how long will it take to fill the remaining part of the tank?`;
                const solutionStepsHTML = `
                    <p><strong>Step 1: Calculate the volume of water already in the tank.</strong></p>
                    <p>Water in tank = ${formatFractionHTML(initialFractionNum, initialFractionDen)} of ${totalCapacity} liters = ${formatDecimal(initialWater)} liters.</p>
                    <p><strong>Step 2: Calculate the remaining volume to be filled.</strong></p>
                    <p>Remaining volume = Total capacity - Water in tank = ${totalCapacity} liters - ${formatDecimal(initialWater)} liters = ${formatDecimal(remainingVolume)} liters.</p>
                    <p><strong>Step 3: Calculate the net filling rate.</strong></p>
                    <p>Net filling rate = Pump rate - Leak rate = ${pumpRate} liters/minute - ${leakRate} liters/minute = ${netFillingRate} liters/minute.</p>
                    <p><strong>Step 4: Calculate the time to fill the remaining part.</strong></p>
                    <p>Time = Remaining volume / Net filling rate</p>
                    <p>Time = ${formatDecimal(remainingVolume)} liters / ${netFillingRate} liters/minute = ${netFillingRate > 0 ? formatDecimal(timeToFill) : 'Tank will not fill (net rate ≤ 0)'} minutes.</p>
                    <p class="final-answer">Final Answer: ${netFillingRate > 0 ? formatDecimal(timeToFill) + " minutes" : 'Tank will not fill'}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 2: Work rate (Tom and Jerry painting)
            function generateWorkRateProblem() {
                const tomTime = getRandomInt(4, 7); 
                const jerryTime = tomTime + getRandomInt(1, 3); 
                const tomAloneHours = getRandomInt(1, tomTime - 2);

                const tomRateNum = 1, tomRateDen = tomTime;
                const jerryRateNum = 1, jerryRateDen = jerryTime;

                const workDoneByTomNum = tomRateNum * tomAloneHours;
                const workDoneByTomDen = tomRateDen;
                const simplifiedWorkByTom = simplifyFraction(workDoneByTomNum, workDoneByTomDen);

                const remainingWorkNum = simplifiedWorkByTom.den - simplifiedWorkByTom.num;
                const remainingWorkDen = simplifiedWorkByTom.den;

                const combinedRateNum = tomRateNum * jerryRateDen + jerryRateNum * tomRateDen;
                const combinedRateDen = tomRateDen * jerryRateDen;
                const simplifiedCombinedRate = simplifyFraction(combinedRateNum, combinedRateDen);

                const timeTogetherNum = remainingWorkNum * simplifiedCombinedRate.den;
                const timeTogetherDen = remainingWorkDen * simplifiedCombinedRate.num;
                const simplifiedTimeTogether = simplifyFraction(timeTogetherNum, timeTogetherDen);
                
                const timeTogetherDecimal = simplifiedTimeTogether.den === 0 ? Infinity : simplifiedTimeTogether.num / simplifiedTimeTogether.den;

                const problemText = `Tom can paint a fence in ${tomTime} hours. Jerry can paint the same fence in ${jerryTime} hours. Tom works alone for ${tomAloneHours} hours, after which Jerry joins him. How long will it take them, working together, to finish the remaining work?`;
                const solutionStepsHTML = `
                    <p><strong>Step 1: Determine individual work rates.</strong></p>
                    <p>Tom's rate = ${formatFractionHTML(tomRateNum, tomRateDen)} of the fence per hour.</p>
                    <p>Jerry's rate = ${formatFractionHTML(jerryRateNum, jerryRateDen)} of the fence per hour.</p>
                    <p><strong>Step 2: Calculate the work done by Tom alone in ${tomAloneHours} hours.</strong></p>
                    <p>Work done by Tom = Tom's rate × Time = ${formatFractionHTML(tomRateNum, tomRateDen)} × ${tomAloneHours} hours = ${formatFractionHTML(workDoneByTomNum, workDoneByTomDen, false)} = ${formatFractionHTML(simplifiedWorkByTom.num, simplifiedWorkByTom.den)} of the fence.</p>
                    <p><strong>Step 3: Calculate the remaining work.</strong></p>
                    <p>Remaining work = 1 - ${formatFractionHTML(simplifiedWorkByTom.num, simplifiedWorkByTom.den)} = ${formatFractionHTML(remainingWorkNum, remainingWorkDen)} of the fence.</p>
                    <p><strong>Step 4: Calculate their combined work rate.</strong></p>
                    <p>Combined rate = ${formatFractionHTML(tomRateNum, tomRateDen)} + ${formatFractionHTML(jerryRateNum, jerryRateDen)} = ${formatFractionHTML(tomRateNum * jerryRateDen + jerryRateNum * tomRateDen, tomRateDen * jerryRateDen, false)} = ${formatFractionHTML(simplifiedCombinedRate.num, simplifiedCombinedRate.den)} of the fence per hour.</p>
                    <p><strong>Step 5: Calculate the time to finish the remaining work together.</strong></p>
                    <p>Time = Remaining work / Combined rate = ${formatFractionHTML(remainingWorkNum, remainingWorkDen)} / ${formatFractionHTML(simplifiedCombinedRate.num, simplifiedCombinedRate.den)} = ${formatFractionHTML(timeTogetherNum, timeTogetherDen, false)} = ${formatFractionHTML(simplifiedTimeTogether.num, simplifiedTimeTogether.den)} hours.</p>
                    <p class="final-answer">Final Answer: ${formatFractionHTML(simplifiedTimeTogether.num, simplifiedTimeTogether.den)} hours (or approx. ${formatDecimal(timeTogetherDecimal)} hours)</p>
                `;
                return { problemText, solutionStepsHTML };
            },
             // Problem 3: Investment growth and withdrawal
            function generateInvestmentProblem() {
                const initialInvestment = getRandomInt(5, 20) * 100; // 500 to 2000
                const growth1Percent = getRandomInt(5, 15); 
                const growth2Percent = getRandomInt(10, 25); 
                const withdrawalFractionDen = getRandomInt(2, 5); 
                const withdrawalFractionNum = 1;

                const amountAfterGrowth1 = initialInvestment * (1 + growth1Percent / 100);
                const amountAfterGrowth2 = amountAfterGrowth1 * (1 + growth2Percent / 100);
                const withdrawalAmount = (withdrawalFractionNum / withdrawalFractionDen) * amountAfterGrowth2;
                const factor = ( (1 + growth1Percent/100) * (1 + growth2Percent/100) );
                const withdrawalFactor = (withdrawalFractionNum/withdrawalFractionDen) * factor;


                const problemText = `Alex invested some money. In the first year, his investment grew by ${growth1Percent}%. In the second year, the new amount grew by ${growth2Percent}%. After these two years, he withdrew $${formatDecimal(withdrawalAmount)}, which he found was exactly ${formatFractionHTML(withdrawalFractionNum,withdrawalFractionDen)} of his total current amount. How much money did Alex initially invest?`;
                const solutionStepsHTML = `
                    <p>Let the initial investment be P.</p>
                    <p><strong>Step 1: Calculate the amount after the first year.</strong></p>
                    <p>Amount after 1st year = P × (1 + ${growth1Percent}/100) = P × ${formatDecimal(1 + growth1Percent/100, 2)}.</p>
                    <p><strong>Step 2: Calculate the amount after the second year.</strong></p>
                    <p>Amount after 2nd year = (P × ${formatDecimal(1 + growth1Percent/100,2)}) × (1 + ${growth2Percent}/100) = P × ${formatDecimal(factor, 4)}.</p>
                    <p>Current total = P × ${formatDecimal(factor, 4)}.</p>
                    <p><strong>Step 3: Set up the equation based on the withdrawal.</strong></p>
                    <p>He withdrew $${formatDecimal(withdrawalAmount)}, which was ${formatFractionHTML(withdrawalFractionNum,withdrawalFractionDen)} of the current total amount.</p>
                    <p>So, ${formatFractionHTML(withdrawalFractionNum,withdrawalFractionDen)} × (P × ${formatDecimal(factor, 4)}) = $${formatDecimal(withdrawalAmount)}.</p>
                    <p>${formatDecimal(withdrawalFactor, 4)}P = $${formatDecimal(withdrawalAmount)}.</p>
                    <p><strong>Step 4: Solve for P.</strong></p>
                    <p>P = $${formatDecimal(withdrawalAmount)} / ${formatDecimal(withdrawalFactor, 4)}</p>
                    <p>P = $${formatDecimal(initialInvestment)}.</p>
                    <p class="final-answer">Final Answer: $${formatDecimal(initialInvestment)}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 4: Cyclist average speed
            function generateCyclistProblem() {
                const speedUp = getRandomInt(8, 12); 
                const speedDownMultiplier = getRandomInt(2,4);
                const speedDown = speedUp * speedDownMultiplier; 
                
                const timeUp = getRandomInt(2,4); 
                const oneWayDistance = speedUp * timeUp;
                const timeDown = oneWayDistance / speedDown;
                const totalTime = timeUp + timeDown;

                const problemText = `A cyclist travels uphill to a destination at an average speed of ${speedUp} km/h and returns downhill along the same route at an average speed of ${speedDown} km/h. If the total journey (uphill and downhill) took ${formatDecimal(totalTime,1)} hours, what is the distance to the destination (one way)?`;
                const solutionStepsHTML = `
                    <p>Let D be the one-way distance to the destination in km.</p>
                    <p><strong>Step 1: Express time taken for each part of the journey.</strong></p>
                    <p>Time uphill (T<sub>up</sub>) = Distance / Speed<sub>up</sub> = D / ${speedUp} hours.</p>
                    <p>Time downhill (T<sub>down</sub>) = Distance / Speed<sub>down</sub> = D / ${speedDown} hours.</p>
                    <p><strong>Step 2: Use the total time to form an equation.</strong></p>
                    <p>Total time = T<sub>up</sub> + T<sub>down</sub> = ${formatDecimal(totalTime,1)} hours.</p>
                    <p>So, ${formatFractionHTML('D',speedUp)} + ${formatFractionHTML('D',speedDown)} = ${formatDecimal(totalTime,1)}.</p>
                    <p><strong>Step 3: Solve the equation for D.</strong></p>
                    <p>D(${formatFractionHTML(1,speedUp)} + ${formatFractionHTML(1,speedDown)}) = ${formatDecimal(totalTime,1)}</p>
                    <p>D(${formatFractionHTML(speedDown + speedUp, speedUp * speedDown, false)}) = ${formatDecimal(totalTime,1)}</p>
                    <p>D = ${formatDecimal(totalTime,1)} × ${formatFractionHTML(speedUp * speedDown, speedUp + speedDown, false)}</p>
                    <p>D = ${formatDecimal(oneWayDistance)} km.</p>
                    <p class="final-answer">Final Answer: ${formatDecimal(oneWayDistance)} km</p>
                `;
                return { problemText, solutionStepsHTML };
            },
            
            // Problem 5: Average of consecutive odd integers
            function generateConsecutiveOddProblem() {
                const middleOdd = getRandomInt(5, 20) * 2 + 1; 
                const int1 = middleOdd - 2;
                const int2 = middleOdd;
                const int3 = middleOdd + 2;
                const average = middleOdd; 
                const x = int1;
                const y = int3;
                const productXY = x * y;

                const problemText = `The average of three consecutive distinct positive odd integers is ${average}. If the smallest of these integers is denoted by 'x', and the largest is denoted by 'y', what is the product of x and y?`;
                const solutionStepsHTML = `
                    <p>Let the three consecutive distinct positive odd integers be n, n+2, and n+4.</p>
                    <p><strong>Step 1: Use the average to find the integers.</strong></p>
                    <p>Since they are consecutive and there are three, the average is the middle integer.</p>
                    <p>Middle integer (n+2) = ${average}.</p>
                    <p>So, n = ${average} - 2 = ${int1}.</p>
                    <p>The three integers are ${int1}, ${int1}+2=${int2}, and ${int1}+4=${int3}.</p>
                    <p><strong>Step 2: Identify 'x' and 'y'.</strong></p>
                    <p>The smallest integer (x) = ${x}.</p>
                    <p>The largest integer (y) = ${y}.</p>
                    <p><strong>Step 3: Calculate the product of x and y.</strong></p>
                    <p>Product = x × y = ${x} × ${y} = ${productXY}.</p>
                    <p class="final-answer">Final Answer: ${productXY}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 6: Percentage change in area of rectangle
            function generateRectangleAreaChangeProblem() {
                const widthMultiplier = getRandomInt(2, 4); 
                const lengthIncreasePercent = getRandomInt(1, 3) * 10; 
                const widthDecreasePercent = getRandomInt(1, 2) * 10; 

                const originalLengthFactor = widthMultiplier; 
                const originalAreaFactor = widthMultiplier; 

                const newLengthFactor = originalLengthFactor * (1 + lengthIncreasePercent / 100);
                const newWidthFactor = 1 * (1 - widthDecreasePercent / 100); 

                const newAreaFactor = newLengthFactor * newWidthFactor;
                const areaChangeFactor = newAreaFactor - originalAreaFactor;
                const percentageChange = (areaChangeFactor / originalAreaFactor) * 100;
                const changeType = percentageChange >= 0 ? "increase" : "decrease";

                const problemText = `The length of a rectangle is ${widthMultiplier === 2 ? "twice" : widthMultiplier + " times"} its width. If the length is increased by ${lengthIncreasePercent}% and the width is decreased by ${widthDecreasePercent}%, what is the percentage change in the area of the rectangle?`;
                const solutionStepsHTML = `
                    <p>Let the original width be W. Then the original length L = ${originalLengthFactor}W.</p>
                    <p><strong>Step 1: Calculate the original area.</strong></p>
                    <p>Original Area (A<sub>1</sub>) = L × W = (${originalLengthFactor}W) × W = ${originalAreaFactor}W<sup>2</sup>.</p>
                    <p><strong>Step 2: Calculate the new dimensions.</strong></p>
                    <p>New Length (L') = L × (1 + ${lengthIncreasePercent}/100) = ${originalLengthFactor}W × ${formatDecimal(1 + lengthIncreasePercent/100,2)} = ${formatDecimal(newLengthFactor,2)}W.</p>
                    <p>New Width (W') = W × (1 - ${widthDecreasePercent}/100) = W × ${formatDecimal(1 - widthDecreasePercent/100,2)} = ${formatDecimal(newWidthFactor,2)}W.</p>
                    <p><strong>Step 3: Calculate the new area.</strong></p>
                    <p>New Area (A<sub>2</sub>) = L' × W' = (${formatDecimal(newLengthFactor,2)}W) × (${formatDecimal(newWidthFactor,2)}W) = ${formatDecimal(newAreaFactor,4)}W<sup>2</sup>.</p>
                    <p><strong>Step 4: Calculate the change in area.</strong></p>
                    <p>Change in Area = A<sub>2</sub> - A<sub>1</sub> = ${formatDecimal(newAreaFactor,4)}W<sup>2</sup> - ${originalAreaFactor}W<sup>2</sup> = ${formatDecimal(areaChangeFactor,4)}W<sup>2</sup>.</p>
                    <p><strong>Step 5: Calculate the percentage change in area.</strong></p>
                    <p>Percentage Change = (Change in Area / Original Area) × 100%</p>
                    <p>Percentage Change = (${formatDecimal(areaChangeFactor,4)}W<sup>2</sup> / ${originalAreaFactor}W<sup>2</sup>) × 100%</p>
                    <p>Percentage Change = (${formatDecimal(areaChangeFactor / originalAreaFactor,4)}) × 100% = ${formatDecimal(Math.abs(percentageChange))}%.</p>
                    <p>Since the change is ${percentageChange >= 0 ? "positive" : "negative"}, it's a ${formatDecimal(Math.abs(percentageChange))}% ${changeType}.</p>
                    <p class="final-answer">Final Answer: ${formatDecimal(Math.abs(percentageChange))}% ${changeType}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 7: Mixture of acid solutions
            function generateMixtureProblem() {
                const vol1 = getRandomInt(4, 10);
                
                const conc1_base = getRandomInt(3, 5); // 30, 40, 50%
                const conc1 = conc1_base * 10;
                
                const conc2_max_base = conc1_base - 2; // ensures conc1 >= conc2 + 20
                const conc2 = getRandomInt(1, Math.max(1, conc2_max_base)) * 10; // Ensure conc2_max_base is at least 1

                const finalConc_min_factor = conc2/10 + 1;
                const finalConc_max_factor = conc1/10 - 1;
                const finalConc = getRandomInt(finalConc_min_factor, finalConc_max_factor) * 10;

                const x_num = vol1 * (conc1 - finalConc);
                const x_den = finalConc - conc2;
                const x = x_num / x_den;
                const simplified_x = simplifyFraction(x_num, x_den);

                const problemText = `How many liters of a ${conc2}% acid solution must be added to ${vol1} liters of a ${conc1}% acid solution to obtain a mixture that is a ${finalConc}% acid solution?`;
                const solutionStepsHTML = `
                    <p>Let x be the volume (in liters) of the ${conc2}% acid solution to be added.</p>
                    <p><strong>Step 1: Calculate the amount of acid in each solution.</strong></p>
                    <p>Acid in the ${conc2}% solution = ${formatDecimal(conc2/100,2)} × x = ${formatDecimal(conc2/100,2)}x liters.</p>
                    <p>Acid in the ${vol1} liters of ${conc1}% solution = ${formatDecimal(conc1/100,2)} × ${vol1} = ${formatDecimal((conc1/100)*vol1,2)} liters.</p>
                    <p><strong>Step 2: Set up expressions for the total volume and total acid in the mixture.</strong></p>
                    <p>Total volume of the mixture = x + ${vol1} liters.</p>
                    <p>Total amount of acid in the mixture = ${formatDecimal(conc2/100,2)}x + ${formatDecimal((conc1/100)*vol1,2)} liters.</p>
                    <p><strong>Step 3: Form an equation based on the desired concentration of the mixture.</strong></p>
                    <p>The mixture is to be ${finalConc}% acid. So, (Total acid / Total volume) = ${formatDecimal(finalConc/100,2)}.</p>
                    <p>(${formatDecimal(conc2/100,2)}x + ${formatDecimal((conc1/100)*vol1,2)}) / (x + ${vol1}) = ${formatDecimal(finalConc/100,2)}.</p>
                    <p><strong>Step 4: Solve the equation for x.</strong></p>
                    <p>${formatDecimal(conc2/100,2)}x + ${formatDecimal((conc1/100)*vol1,2)} = ${formatDecimal(finalConc/100,2)}(x + ${vol1})</p>
                    <p>${formatDecimal(conc2/100,2)}x + ${formatDecimal((conc1/100)*vol1,2)} = ${formatDecimal(finalConc/100,2)}x + ${formatDecimal((finalConc/100)*vol1,2)}</p>
                    <p>${formatDecimal((conc1/100)*vol1 - (finalConc/100)*vol1,2)} = (${formatDecimal(finalConc/100,2)} - ${formatDecimal(conc2/100,2)})x</p>
                    <p>${formatDecimal(((conc1 - finalConc)*vol1)/100,2)} = ${formatDecimal((finalConc - conc2)/100,2)}x</p>
                    <p>x = ${formatDecimal((conc1 - finalConc)*vol1,0)} / ${formatDecimal(finalConc - conc2,0)} = ${formatDecimal(x,2)} liters.</p>
                    <p class="final-answer">Final Answer: ${formatFractionHTML(simplified_x.num, simplified_x.den)} liters (or approximately ${formatDecimal(x,2)} liters)</p>
                `;
                return { problemText, solutionStepsHTML };
            },
            
            // Problem 8: Shopkeeper markup and discount
            function generateShopkeeperProblem() {
                const costPrice = getRandomInt(10, 50) * 10; 
                const markupPercent = getRandomInt(3, 8) * 10; 
                const discountPercent = getRandomInt(1, Math.max(1, Math.floor(markupPercent/10)-1)) * 10; 

                const markedPrice = costPrice * (1 + markupPercent / 100);
                const sellingPrice = markedPrice * (1 - discountPercent / 100);
                const finalFactor = (1 + markupPercent/100) * (1 - discountPercent/100);

                const problemText = `A shopkeeper marks an item ${markupPercent}% above its cost price. He then offers a ${discountPercent}% discount on the marked price. If the item sells for $${formatDecimal(sellingPrice)}, what was the original cost price of the item?`;
                const solutionStepsHTML = `
                    <p>Let the Cost Price (CP) be C.</p>
                    <p><strong>Step 1: Calculate the Marked Price (MP).</strong></p>
                    <p>MP = CP × (1 + ${markupPercent}/100) = CP × ${formatDecimal(1 + markupPercent/100,2)}.</p>
                    <p><strong>Step 2: Calculate the Selling Price (SP) after discount.</strong></p>
                    <p>SP = MP × (1 - ${discountPercent}/100) = (CP × ${formatDecimal(1 + markupPercent/100,2)}) × ${formatDecimal(1 - discountPercent/100,2)}.</p>
                    <p>SP = CP × ${formatDecimal(finalFactor,3)}.</p>
                    <p><strong>Step 3: Use the given selling price to find the cost price.</strong></p>
                    <p>SP = $${formatDecimal(sellingPrice)}.</p>
                    <p>CP × ${formatDecimal(finalFactor,3)} = $${formatDecimal(sellingPrice)}.</p>
                    <p>C = $${formatDecimal(sellingPrice)} / ${formatDecimal(finalFactor,3)} = $${formatDecimal(costPrice)}.</p>
                    <p class="final-answer">Final Answer: $${formatDecimal(costPrice)}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 9: Ages ratio problem
            function generateAgesRatioProblem() {
                const ratioA = getRandomInt(2, 4);
                const ratioB = ratioA + getRandomInt(1, 2);
                const x = getRandomInt(3, 7); 
                const yearsAgo = 5; 
                const yearsHence = 5; 

                const sumAgesHence = (ratioA * x + yearsAgo + yearsHence) + (ratioB * x + yearsAgo + yearsHence);
                const benCurrentAgeNum = ratioB * x + yearsAgo;

                const problemText = `${yearsAgo} years ago, the ratio of Anna's age to Ben's age was ${ratioA}:${ratioB}. In ${yearsHence} years from now, the sum of their ages will be ${sumAgesHence}. What is Ben's current age?`;
                const solutionStepsHTML = `
                    <p>Let Anna's age ${yearsAgo} years ago be ${ratioA}x and Ben's age ${yearsAgo} years ago be ${ratioB}x.</p>
                    <p><strong>Step 1: Express their current ages.</strong></p>
                    <p>Anna's current age = ${ratioA}x + ${yearsAgo}.</p>
                    <p>Ben's current age = ${ratioB}x + ${yearsAgo}.</p>
                    <p><strong>Step 2: Express their ages in ${yearsHence} years from now.</strong></p>
                    <p>Anna's age in ${yearsHence} years = (${ratioA}x + ${yearsAgo}) + ${yearsHence} = ${ratioA}x + ${yearsAgo + yearsHence}.</p>
                    <p>Ben's age in ${yearsHence} years = (${ratioB}x + ${yearsAgo}) + ${yearsHence} = ${ratioB}x + ${yearsAgo + yearsHence}.</p>
                    <p><strong>Step 3: Use the sum of their ages in ${yearsHence} years to form an equation.</strong></p>
                    <p>Sum = (${ratioA}x + ${yearsAgo + yearsHence}) + (${ratioB}x + ${yearsAgo + yearsHence}) = ${sumAgesHence}.</p>
                    <p>(${ratioA + ratioB})x + ${2 * (yearsAgo + yearsHence)} = ${sumAgesHence}.</p>
                    <p><strong>Step 4: Solve for x.</strong></p>
                    <p>(${ratioA + ratioB})x = ${sumAgesHence} - ${2 * (yearsAgo + yearsHence)} = ${sumAgesHence - 2 * (yearsAgo + yearsHence)}}.</p>
                    <p>x = ${formatFractionHTML(sumAgesHence - 2 * (yearsAgo + yearsHence), ratioA + ratioB)} = ${x}.</p>
                    <p><strong>Step 5: Calculate Ben's current age.</strong></p>
                    <p>Ben's current age = ${ratioB}x + ${yearsAgo} = ${ratioB} × ${x} + ${yearsAgo} = ${benCurrentAgeNum}.</p>
                    <p class="final-answer">Final Answer: ${benCurrentAgeNum} years</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 10: Pipes filling/emptying cistern
            function generatePipesCisternProblem() {
                let ta, tb, tc, simplifiedCombined;
                let attempts = 0;
                do {
                    ta = getRandomInt(10, 20); 
                    tb = getRandomInt(ta + 1, ta + 10); 
                    tc = getRandomInt(Math.max(5, Math.min(ta,tb)-5) , Math.max(ta,tb)+5 ); 
                    
                    const combinedNum = (tb * tc) + (ta * tc) - (ta * tb);
                    const combinedDen = ta * tb * tc;
                    simplifiedCombined = simplifyFraction(combinedNum, combinedDen);
                    attempts++;
                    if (attempts > 50) { // Failsafe
                        ta=12; tb=15; tc=10; // Fallback to known good values
                        simplifiedCombined = simplifyFraction( (150+120-180), 12*15*10); // 3/60 = 1/20
                        break;
                    }
                } while (simplifiedCombined.num <= 0 || simplifiedCombined.den === 0);

                const initialFillNum = 1;
                const initialFillDen = getRandomInt(2, 4); 

                const remainingFillNum = initialFillDen - initialFillNum;
                const remainingFillDen = initialFillDen;

                const timeToFillNum = remainingFillNum * simplifiedCombined.den;
                const timeToFillDen = remainingFillDen * simplifiedCombined.num;
                const simplifiedTimeToFill = simplifyFraction(timeToFillNum, timeToFillDen);
                const timeToFillDecimal = simplifiedTimeToFill.den === 0 ? Infinity : simplifiedTimeToFill.num / simplifiedTimeToFill.den;

                const problemText = `Pipe A can fill a cistern in ${ta} minutes. Pipe B can fill the same cistern in ${tb} minutes. Pipe C can empty the full cistern in ${tc} minutes. If all three pipes are opened simultaneously when the cistern is ${formatFractionHTML(initialFillNum,initialFillDen)} full, how long will it take to fill the cistern?`;
                const solutionStepsHTML = `
                    <p><strong>Step 1: Rates (fraction of cistern per minute).</strong></p>
                    <p>Rate A = +${formatFractionHTML(1, ta)}. Rate B = +${formatFractionHTML(1, tb)}. Rate C = -${formatFractionHTML(1, tc)}.</p>
                    <p><strong>Step 2: Combined rate.</strong></p>
                    <p>Combined rate = ${formatFractionHTML(1, ta)} + ${formatFractionHTML(1, tb)} - ${formatFractionHTML(1, tc)} = ${formatFractionHTML(simplifiedCombined.num, simplifiedCombined.den)} cistern/minute.</p>
                    <p><strong>Step 3: Fraction remaining to fill.</strong></p>
                    <p>Remaining = 1 - ${formatFractionHTML(initialFillNum, initialFillDen)} = ${formatFractionHTML(remainingFillNum, remainingFillDen)}.</p>
                    <p><strong>Step 4: Time to fill remaining part.</strong></p>
                    <p>Time = Work / Rate = ${formatFractionHTML(remainingFillNum, remainingFillDen)} / ${formatFractionHTML(simplifiedCombined.num, simplifiedCombined.den)} = ${formatFractionHTML(simplifiedTimeToFill.num, simplifiedTimeToFill.den)} minutes.</p>
                    <p class="final-answer">Final Answer: ${formatFractionHTML(simplifiedTimeToFill.num, simplifiedTimeToFill.den)} minutes (approx. ${formatDecimal(timeToFillDecimal)} minutes)</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 11: Average score change
            function generateAverageScoreProblem() {
                const numStudents = getRandomInt(20, 40);
                const originalAverage = getRandomInt(60, 85);
                const scoreLeft = getRandomInt(Math.max(30, originalAverage-20), originalAverage + 5); 
                const newAverageIncrease = getRandomInt(1, 3); 
                const newAverage = originalAverage + newAverageIncrease;

                const originalTotalScore = numStudents * originalAverage;
                const totalScoreAfterLeft = originalTotalScore - scoreLeft;
                const newTotalScore = numStudents * newAverage; 
                const scoreNewStudent = newTotalScore - totalScoreAfterLeft;

                const problemText = `The average score of a class of ${numStudents} students on a test was ${originalAverage}. After one student who scored ${scoreLeft} left the class, and a new student joined, the new average score of the class (which still has ${numStudents} students) became ${newAverage}. What was the score of the new student?`;
                const solutionStepsHTML = `
                    <p><strong>Step 1: Original total score.</strong></p>
                    <p>${numStudents} × ${originalAverage} = ${originalTotalScore}.</p>
                    <p><strong>Step 2: Total score after one student left.</strong></p>
                    <p>${originalTotalScore} - ${scoreLeft} = ${totalScoreAfterLeft} (for ${numStudents -1} students).</p>
                    <p><strong>Step 3: New total score with new student.</strong></p>
                    <p>${numStudents} × ${newAverage} = ${newTotalScore}.</p>
                    <p><strong>Step 4: Score of the new student.</strong></p>
                    <p>New Student Score = New Total - Total of remaining students = ${newTotalScore} - ${totalScoreAfterLeft} = ${scoreNewStudent}.</p>
                    <p class="final-answer">Final Answer: ${scoreNewStudent}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 12: Combined ratios a:d
            function generateCombinedRatiosProblem() {
                const a_b_num = getRandomInt(1, 4);
                const a_b_den = getRandomInt(a_b_num + 1, 5);
                const b_c_num = getRandomInt(1, 4);
                const b_c_den = getRandomInt(b_c_num + 1, 5);
                const c_d_num = getRandomInt(1, 4);
                const c_d_den = getRandomInt(c_d_num + 1, 5);

                const ad_num = a_b_num * b_c_num * c_d_num;
                const ad_den = a_b_den * b_c_den * c_d_den;
                const simplified_ad = simplifyFraction(ad_num, ad_den);

                const problemText = `Given the ratios a:b = ${a_b_num}:${a_b_den}, b:c = ${b_c_num}:${b_c_den}, and c:d = ${c_d_num}:${c_d_den}, what is the ratio a:d?`;
                const solutionStepsHTML = `
                    <p>${formatFractionHTML('a','b')} = ${formatFractionHTML(a_b_num,a_b_den)}, ${formatFractionHTML('b','c')} = ${formatFractionHTML(b_c_num,b_c_den)}, ${formatFractionHTML('c','d')} = ${formatFractionHTML(c_d_num,c_d_den)}</p>
                    <p><strong>Step 1: Multiply fractions for a:d.</strong></p>
                    <p>${formatFractionHTML('a','d')} = ${formatFractionHTML(a_b_num,a_b_den)} × ${formatFractionHTML(b_c_num,b_c_den)} × ${formatFractionHTML(c_d_num,c_d_den)}</p>
                    <p><strong>Step 2: Perform multiplication.</strong></p>
                    <p>${formatFractionHTML('a','d')} = ${formatFractionHTML(ad_num, ad_den, false)}</p>
                    <p><strong>Step 3: Simplify.</strong></p>
                    <p>${formatFractionHTML('a','d')} = ${formatFractionHTML(simplified_ad.num, simplified_ad.den)}.</p>
                    <p class="final-answer">Final Answer: ${simplified_ad.num}:${simplified_ad.den}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 13: Train speed quadratic equation
            function generateTrainSpeedProblem() {
                let originalSpeed, speedIncrease, originalTime, distance, newSpeed, newTime, timeSaved;
                let attempts = 0;
                const MAX_ATTEMPTS = 100;

                do {
                    originalSpeed = getRandomInt(20, 70); 
                    speedIncrease = getRandomInt(5, 25); 
                    originalTime = getRandomInt(4, 20); 

                    distance = originalSpeed * originalTime;
                    newSpeed = originalSpeed + speedIncrease;
                    
                    if (distance <= 0 || newSpeed <= 0 || distance % newSpeed !== 0) { 
                        attempts++;
                        if (attempts > MAX_ATTEMPTS) { 
                            originalSpeed=30; speedIncrease=10; originalTime=12; // Known good set
                            distance = 360; newSpeed = 40;
                        }
                        continue;
                    }
                    newTime = distance / newSpeed;
                    timeSaved = originalTime - newTime;
                    attempts++;
                     if (attempts > MAX_ATTEMPTS) { 
                        originalSpeed=30; speedIncrease=10; originalTime=12; distance = 360; newSpeed = 40; timeSaved = 3; break;
                    }
                } while (timeSaved <= 0 || !Number.isInteger(timeSaved) || timeSaved > Math.floor(originalTime * 0.75) || timeSaved < 1 ); 
                
                const coeff_a = timeSaved;
                const coeff_b = speedIncrease * timeSaved;
                const coeff_c = -1 * speedIncrease * distance;
                const common_divisor = gcd(gcd(Math.abs(coeff_a),Math.abs(coeff_b)),Math.abs(coeff_c));
                const simplified_a = coeff_a / common_divisor;
                const simplified_b = coeff_b / common_divisor;
                const simplified_c = coeff_c / common_divisor;

                const problemText = `A train is scheduled to cover a distance of ${distance} km at a uniform speed. If its speed were ${speedIncrease} km/h more than planned, it would have taken ${timeSaved} hours less for the journey. What is the original planned speed of the train?`;
                const solutionStepsHTML = `
                    <p>Let original speed be S km/h, original time T hours. Distance D = ${distance} km.</p>
                    <p>D = S × T  => T = ${distance}/S.</p>
                    <p>New speed = S + ${speedIncrease}, New time = T - ${timeSaved}.</p>
                    <p>D = (S + ${speedIncrease})(T - ${timeSaved}).</p>
                    <p>Substitute T: ${distance} = (S + ${speedIncrease})(${formatFractionHTML(distance,'S')} - ${timeSaved}).</p>
                    <p>Multiply by S: ${distance}S = (S + ${speedIncrease})(${distance} - ${timeSaved}S).</p>
                    <p>${distance}S = ${distance}S - ${timeSaved}S<sup>2</sup> + ${speedIncrease*distance} - ${speedIncrease*timeSaved}S.</p>
                    <p>0 = -${timeSaved}S<sup>2</sup> - ${speedIncrease*timeSaved}S + ${speedIncrease*distance}.</p>
                    <p>Simplified: ${simplified_a}S<sup>2</sup> + ${simplified_b}S + ${simplified_c} = 0.</p>
                    <p>Factoring or using quadratic formula gives S = ${originalSpeed} (positive solution).</p>
                    <p class="final-answer">Final Answer: ${originalSpeed} km/h</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 14: Price increase then decrease by x%
            function generatePriceChangeXPercentProblem() {
                const x = getRandomInt(1, 4) * 5; // 5, 10, 15, 20%
                const originalPrice = 100; 

                const priceAfterIncrease = originalPrice * (1 + x/100);
                const finalPrice = priceAfterIncrease * (1 - x/100);
                const finalPricePercentage = (finalPrice / originalPrice) * 100;

                const problemText = `The price of an item was first increased by x%. Later, the new price was decreased by x%. If the final price was ${formatDecimal(finalPricePercentage)}% of the original price, what is the value of x?`;
                const solutionStepsHTML = `
                    <p>Let original price be P.</p>
                    <p>After x% increase: P(1 + x/100).</p>
                    <p>After x% decrease on new price: P(1 + x/100)(1 - x/100).</p>
                    <p>This equals ${formatDecimal(finalPricePercentage/100, 4)}P.</p>
                    <p>(1 + x/100)(1 - x/100) = ${formatDecimal(finalPricePercentage/100, 4)}.</p>
                    <p>1 - (x/100)<sup>2</sup> = ${formatDecimal(finalPricePercentage/100, 4)}.</p>
                    <p>(x/100)<sup>2</sup> = 1 - ${formatDecimal(finalPricePercentage/100, 4)} = ${formatDecimal(1 - finalPricePercentage/100, 4)}.</p>
                    <p>x<sup>2</sup>/10000 = ${formatDecimal(1 - finalPricePercentage/100, 4)}.</p>
                    <p>x<sup>2</sup> = ${formatDecimal((1 - finalPricePercentage/100) * 10000, 0)}.</p>
                    <p>x = √${formatDecimal((1 - finalPricePercentage/100) * 10000, 0)} = ${x}.</p>
                    <p class="final-answer">Final Answer: ${x}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 15: Boat upstream/downstream
            function generateBoatStreamProblem() {
                let boatSpeed, streamSpeed, speedUpstream, speedDownstream, timeUpstream, distance, timeDownstream;
                let attempts = 0;
                const MAX_ATTEMPTS = 100;
                do {
                    boatSpeed = getRandomInt(5, 20); 
                    streamSpeed = getRandomInt(1, Math.max(1, boatSpeed - 2)); 

                    speedUpstream = boatSpeed - streamSpeed;
                    speedDownstream = boatSpeed + streamSpeed;

                    timeUpstream = getRandomInt(2, 6);
                    distance = speedUpstream * timeUpstream;
                    
                    if (speedDownstream <= 0 || distance % speedDownstream !== 0) {
                         attempts++;
                         if(attempts > MAX_ATTEMPTS) { boatSpeed=6; streamSpeed=2; timeUpstream=6; distance=24; speedDownstream=8;} // Failsafe
                         continue;
                    }
                    timeDownstream = distance / speedDownstream;
                    attempts++;
                    if(attempts > MAX_ATTEMPTS) { boatSpeed=6; streamSpeed=2; timeUpstream=6; distance=24; speedDownstream=8; timeDownstream=3; break;}
                } while (timeDownstream <=0 || !Number.isInteger(timeDownstream));


                const problemText = `A boat travels ${distance} km upstream in ${timeUpstream} hours. It travels the same distance (${distance} km) downstream in ${formatDecimal(timeDownstream)} hours. What is the speed of the boat in still water and the speed of the stream?`;
                const solutionStepsHTML = `
                    <p>Let B = boat speed in still water, S = stream speed.</p>
                    <p>Upstream speed = B - S. Downstream speed = B + S.</p>
                    <p>Upstream: ${distance} = (B - S) × ${timeUpstream}  => B - S = ${speedUpstream} (Eq 1)</p>
                    <p>Downstream: ${distance} = (B + S) × ${formatDecimal(timeDownstream)} => B + S = ${speedDownstream} (Eq 2)</p>
                    <p>Add (Eq 1) + (Eq 2): 2B = ${speedUpstream + speedDownstream} => B = ${boatSpeed} km/h.</p>
                    <p>Substitute B in (Eq 2): ${boatSpeed} + S = ${speedDownstream} => S = ${streamSpeed} km/h.</p>
                    <p class="final-answer">Final Answer: Boat speed = ${boatSpeed} km/h, Stream speed = ${streamSpeed} km/h</p>
                `;
                return { problemText, solutionStepsHTML };
            }
        ];

        function generateNewTestData() {
            currentProblemsData = problemGenerators.map(generator => {
                try {
                    return generator();
                } catch (e) {
                    console.error("Error in problem generator:", e);
                    return { 
                        problemText: "Error generating this problem. Please try again.",
                        solutionStepsHTML: `<p>An error occurred: ${e.message}</p>`
                    };
                }
            });
        }

        function displayProblems() {
            problemListContainer.innerHTML = ''; 
            showSolutionsBtn.textContent = 'Show Solutions';
            showSolutionsBtn.disabled = false;

            currentProblemsData.forEach((data, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="problem-number">${index + 1}.</span>
                    <div class="problem-text-container">${data.problemText}</div>
                    <span class="answer-space">Answer: ____________</span>
                    <div class="solution-steps" id="solution-${index + 1}">
                        ${data.solutionStepsHTML}
                    </div>
                `;
                problemListContainer.appendChild(listItem);
            });

            const solutions = document.querySelectorAll('.solution-steps');
            solutions.forEach(sol => sol.style.display = 'none');
            const problemItems = document.querySelectorAll('.problem-list > li');
            problemItems.forEach(item => item.classList.remove('solutions-shown'));
        }

        function handleGenerateTest() {
            generateNewTestData();
            displayProblems();
        }

        function showSolutions() {
            const solutions = document.querySelectorAll('.solution-steps');
            const problemItems = document.querySelectorAll('.problem-list > li');

            if (solutions.length === 0) return;

            let shouldShowAll = false;
            solutions.forEach(sol => {
                if (sol.style.display === 'none') {
                    shouldShowAll = true;
                }
            });

            if (shouldShowAll) {
                solutions.forEach(sol => sol.style.display = 'block');
                problemItems.forEach(item => item.classList.add('solutions-shown'));
                showSolutionsBtn.textContent = 'Solutions Shown';
                showSolutionsBtn.disabled = true; 
            }
        }

        generateTestBtn.addEventListener('click', handleGenerateTest);
        showSolutionsBtn.addEventListener('click', showSolutions);
        
        handleGenerateTest();

    </script>
</body>
</html>
