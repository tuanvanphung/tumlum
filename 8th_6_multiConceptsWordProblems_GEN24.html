<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Multi-Concept Word Problems Practice</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #fdfdff;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .controls-container {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        .controls-container button {
            padding: 10px 20px;
            font-size: 1em;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 10px;
        }
        #generateTestButton { background-color: #007bff; }
        #generateTestButton:hover { background-color: #0056b3; }
        #showSolutionsButton { background-color: #28a745; }
        #showSolutionsButton:hover { background-color: #218838; }
        #showSolutionsButton:disabled {
            background-color: #6c757d; /* Gray when disabled */
            cursor: not-allowed;
        }

        .problem-list {
            list-style-type: none;
            padding-left: 0;
        }
        .problem-list li {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
        }
        .problem-number {
            font-weight: bold;
            margin-right: 10px;
            font-size: 1.1em;
        }
        .problem-text-container {
            font-family: 'Georgia', serif;
            font-size: 1.1em;
            color: #444;
            display: block;
            margin-bottom: 10px;
            word-wrap: break-word;
        }
        .answer-space {
            display: block;
            margin-top: 10px;
            font-style: italic;
            color: #777;
        }
        .solution-steps {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #e9f5ff; /* Light blue background */
            border: 1px dashed #5bc0de; /* Info blue border */
            border-radius: 4px;
            font-family: 'Arial', sans-serif; /* Clear font for solutions */
            font-size: 1.0em;
            line-height: 1.5;
        }
        .solution-steps p {
            margin: 8px 0;
            word-wrap: break-word;
        }
        .solution-steps .final-answer {
            font-weight: bold;
            color: #007bff; /* Primary blue for final answer */
            margin-top:10px;
            padding-top:5px;
            border-top: 1px solid #ccc;
        }
    </style>
</head>
<body>

    <h1>Comprehensive Multi-Concept Word Problems Practice</h1>

    <div class="controls-container">
        <button id="generateTestButton">Generate New Test</button>
        <button id="showSolutionsButton">Show Solutions</button>
    </div>

    <ol class="problem-list" id="problemListContainer">
        <!-- Problems will be dynamically inserted here -->
    </ol>

    <script>
        const problemListContainer = document.getElementById('problemListContainer');
        const showSolutionsBtn = document.getElementById('showSolutionsButton');
        const generateTestBtn = document.getElementById('generateTestButton');
        let currentProblemsData = [];

        // --- Helper Functions ---
        function getRandomInt(min, max) {
            if (min > max) { 
                [min, max] = [max, min];
            }
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function gcd(a, b) {
            a = Math.abs(a);
            b = Math.abs(b);
            if (b === 0) return a;
            return gcd(b, a % b);
        }
         function lcm(a, b) {
            if (a === 0 || b === 0) return 0;
            return Math.abs(a * b) / gcd(a, b);
        }


        function simplifyFraction(numerator, denominator) {
            if (denominator === 0) return { num: numerator, den: denominator }; 
            const commonDivisor = gcd(numerator, denominator);
            let num = numerator / commonDivisor;
            let den = denominator / commonDivisor;
            if (den < 0) { 
                num = -num;
                den = -den;
            }
            return { num, den };
        }
        
        function formatDecimal(value, places = 2) {
            if (!isFinite(value) || typeof value !== 'number') { 
                return String(value); 
            }
            if (Number.isInteger(value)) return value.toString();
            if (Math.abs(value - Math.round(value)) < 1e-9) {
                 return Math.round(value).toString();
            }
            return value.toFixed(places);
        }

        function formatFractionHTML(num, den, simplifyResult = true) { 
            if (typeof num !== 'number' || typeof den !== 'number' || !isFinite(num) || !isFinite(den)) {
                 return "Invalid Fraction Input";
            }
            if (den === 0) return "Error: Div by 0";
            if (simplifyResult) {
                const simplified = simplifyFraction(num, den);
                num = simplified.num;
                den = simplified.den;
            }
            if (den === 1) return `${num}`;
            if (num === 0) return `0`; 
            return `<span class="fraction"><span class="numerator">${num}</span><span class="denominator">${den}</span></span>`;
        }


        // --- Problem Generator Functions (Original Set) ---
        const problemGenerators_Set1 = [
            // Problem 1: Tank filling with leak
            function generateTankProblem() {
                const initialFractionDen = getRandomInt(3, 5);
                const initialFractionNum = getRandomInt(1, initialFractionDen - 1);
                const pumpRate = getRandomInt(8, 20);
                const leakRate = getRandomInt(1, Math.max(1, Math.floor(pumpRate * 0.6))); 
                const totalCapacity = getRandomInt(10, 30) * 10; 

                const initialWater = (initialFractionNum / initialFractionDen) * totalCapacity;
                const remainingVolume = totalCapacity - initialWater;
                const netFillingRate = pumpRate - leakRate;
                let timeToFill = 0;
                if (netFillingRate <= 0) { 
                    timeToFill = Infinity; 
                } else {
                    timeToFill = remainingVolume / netFillingRate;
                }
                
                const problemText = `A tank is ${formatFractionHTML(initialFractionNum, initialFractionDen)} full of water. A pump starts filling it at a rate of ${pumpRate} liters per minute. However, there is a leak in the tank that drains water at a rate of ${leakRate} liters per minute. If the total capacity of the tank is ${totalCapacity} liters, how long will it take to fill the remaining part of the tank?`;
                const solutionStepsHTML = `
                    <p><strong>Step 1: Calculate the volume of water already in the tank.</strong></p>
                    <p>Water in tank = ${formatFractionHTML(initialFractionNum, initialFractionDen)} of ${totalCapacity} liters = ${formatDecimal(initialWater)} liters.</p>
                    <p><strong>Step 2: Calculate the remaining volume to be filled.</strong></p>
                    <p>Remaining volume = Total capacity - Water in tank = ${totalCapacity} liters - ${formatDecimal(initialWater)} liters = ${formatDecimal(remainingVolume)} liters.</p>
                    <p><strong>Step 3: Calculate the net filling rate.</strong></p>
                    <p>Net filling rate = Pump rate - Leak rate = ${pumpRate} liters/minute - ${leakRate} liters/minute = ${netFillingRate} liters/minute.</p>
                    <p><strong>Step 4: Calculate the time to fill the remaining part.</strong></p>
                    <p>Time = Remaining volume / Net filling rate</p>
                    <p>Time = ${formatDecimal(remainingVolume)} liters / ${netFillingRate} liters/minute = ${netFillingRate > 0 ? formatDecimal(timeToFill) : 'Tank will not fill (net rate ≤ 0)'} minutes.</p>
                    <p class="final-answer">Final Answer: ${netFillingRate > 0 ? formatDecimal(timeToFill) + " minutes" : 'Tank will not fill'}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 2: Work rate (Tom and Jerry painting)
            function generateWorkRateProblem() {
                const tomTime = getRandomInt(4, 7); 
                const jerryTime = tomTime + getRandomInt(1, 3); 
                const tomAloneHours = getRandomInt(1, Math.max(1, tomTime - 2));

                const tomRateNum = 1, tomRateDen = tomTime;
                const jerryRateNum = 1, jerryRateDen = jerryTime;

                const workDoneByTomNum = tomRateNum * tomAloneHours;
                const workDoneByTomDen = tomRateDen;
                const simplifiedWorkByTom = simplifyFraction(workDoneByTomNum, workDoneByTomDen);

                const remainingWorkNum = simplifiedWorkByTom.den - simplifiedWorkByTom.num;
                const remainingWorkDen = simplifiedWorkByTom.den;

                const combinedRateNum = tomRateNum * jerryRateDen + jerryRateNum * tomRateDen;
                const combinedRateDen = tomRateDen * jerryRateDen;
                const simplifiedCombinedRate = simplifyFraction(combinedRateNum, combinedRateDen);

                const timeTogetherNum = remainingWorkNum * simplifiedCombinedRate.den;
                const timeTogetherDen = remainingWorkDen * simplifiedCombinedRate.num;
                const simplifiedTimeTogether = simplifyFraction(timeTogetherNum, timeTogetherDen);
                
                const timeTogetherDecimal = simplifiedTimeTogether.den === 0 ? Infinity : simplifiedTimeTogether.num / simplifiedTimeTogether.den;

                const problemText = `Tom can paint a fence in ${tomTime} hours. Jerry can paint the same fence in ${jerryTime} hours. Tom works alone for ${tomAloneHours} hours, after which Jerry joins him. How long will it take them, working together, to finish the remaining work?`;
                const solutionStepsHTML = `
                    <p><strong>Step 1: Determine individual work rates.</strong></p>
                    <p>Tom's rate = ${formatFractionHTML(tomRateNum, tomRateDen)} of the fence per hour.</p>
                    <p>Jerry's rate = ${formatFractionHTML(jerryRateNum, jerryRateDen)} of the fence per hour.</p>
                    <p><strong>Step 2: Calculate the work done by Tom alone in ${tomAloneHours} hours.</strong></p>
                    <p>Work done by Tom = Tom's rate × Time = ${formatFractionHTML(tomRateNum, tomRateDen)} × ${tomAloneHours} hours = ${formatFractionHTML(workDoneByTomNum, workDoneByTomDen, false)} = ${formatFractionHTML(simplifiedWorkByTom.num, simplifiedWorkByTom.den)} of the fence.</p>
                    <p><strong>Step 3: Calculate the remaining work.</strong></p>
                    <p>Remaining work = 1 - ${formatFractionHTML(simplifiedWorkByTom.num, simplifiedWorkByTom.den)} = ${formatFractionHTML(remainingWorkNum, remainingWorkDen)} of the fence.</p>
                    <p><strong>Step 4: Calculate their combined work rate.</strong></p>
                    <p>Combined rate = ${formatFractionHTML(tomRateNum, tomRateDen)} + ${formatFractionHTML(jerryRateNum, jerryRateDen)} = ${formatFractionHTML(tomRateNum * jerryRateDen + jerryRateNum * tomRateDen, tomRateDen * jerryRateDen, false)} = ${formatFractionHTML(simplifiedCombinedRate.num, simplifiedCombinedRate.den)} of the fence per hour.</p>
                    <p><strong>Step 5: Calculate the time to finish the remaining work together.</strong></p>
                    <p>Time = Remaining work / Combined rate = ${formatFractionHTML(remainingWorkNum, remainingWorkDen)} / ${formatFractionHTML(simplifiedCombinedRate.num, simplifiedCombinedRate.den)} = ${formatFractionHTML(timeTogetherNum, timeTogetherDen, false)} = ${formatFractionHTML(simplifiedTimeTogether.num, simplifiedTimeTogether.den)} hours.</p>
                    <p class="final-answer">Final Answer: ${formatFractionHTML(simplifiedTimeTogether.num, simplifiedTimeTogether.den)} hours (or approx. ${formatDecimal(timeTogetherDecimal)} hours)</p>
                `;
                return { problemText, solutionStepsHTML };
            },
             // Problem 3: Investment growth and withdrawal
            function generateInvestmentProblem() {
                const initialInvestment = getRandomInt(5, 20) * 100; 
                const growth1Percent = getRandomInt(5, 15); 
                const growth2Percent = getRandomInt(10, 25); 
                const withdrawalFractionDen = getRandomInt(2, 5); 
                const withdrawalFractionNum = 1;

                const amountAfterGrowth1 = initialInvestment * (1 + growth1Percent / 100);
                const amountAfterGrowth2 = amountAfterGrowth1 * (1 + growth2Percent / 100);
                const withdrawalAmount = (withdrawalFractionNum / withdrawalFractionDen) * amountAfterGrowth2;
                const factor = ( (1 + growth1Percent/100) * (1 + growth2Percent/100) );
                const withdrawalFactor = (withdrawalFractionNum/withdrawalFractionDen) * factor;


                const problemText = `Alex invested some money. In the first year, his investment grew by ${growth1Percent}%. In the second year, the new amount grew by ${growth2Percent}%. After these two years, he withdrew $${formatDecimal(withdrawalAmount)}, which he found was exactly ${formatFractionHTML(withdrawalFractionNum,withdrawalFractionDen)} of his total current amount. How much money did Alex initially invest?`;
                const solutionStepsHTML = `
                    <p>Let the initial investment be P.</p>
                    <p><strong>Step 1: Calculate the amount after the first year.</strong></p>
                    <p>Amount after 1st year = P × (1 + ${growth1Percent}/100) = P × ${formatDecimal(1 + growth1Percent/100, 2)}.</p>
                    <p><strong>Step 2: Calculate the amount after the second year.</strong></p>
                    <p>Amount after 2nd year = (P × ${formatDecimal(1 + growth1Percent/100,2)}) × (1 + ${growth2Percent}/100) = P × ${formatDecimal(factor, 4)}.</p>
                    <p>Current total = P × ${formatDecimal(factor, 4)}.</p>
                    <p><strong>Step 3: Set up the equation based on the withdrawal.</strong></p>
                    <p>He withdrew $${formatDecimal(withdrawalAmount)}, which was ${formatFractionHTML(withdrawalFractionNum,withdrawalFractionDen)} of the current total amount.</p>
                    <p>So, ${formatFractionHTML(withdrawalFractionNum,withdrawalFractionDen)} × (P × ${formatDecimal(factor, 4)}) = $${formatDecimal(withdrawalAmount)}.</p>
                    <p>${formatDecimal(withdrawalFactor, 4)}P = $${formatDecimal(withdrawalAmount)}.</p>
                    <p><strong>Step 4: Solve for P.</strong></p>
                    <p>P = $${formatDecimal(withdrawalAmount)} / ${formatDecimal(withdrawalFactor, 4)}</p>
                    <p>P = $${formatDecimal(initialInvestment)}.</p>
                    <p class="final-answer">Final Answer: $${formatDecimal(initialInvestment)}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 4: Cyclist average speed
            function generateCyclistProblem() {
                const speedUp = getRandomInt(8, 12); 
                const speedDownMultiplier = getRandomInt(2,4);
                const speedDown = speedUp * speedDownMultiplier; 
                
                const timeUp = getRandomInt(2,4); 
                const oneWayDistance = speedUp * timeUp;
                const timeDown = oneWayDistance / speedDown;
                const totalTime = timeUp + timeDown;

                const problemText = `A cyclist travels uphill to a destination at an average speed of ${speedUp} km/h and returns downhill along the same route at an average speed of ${speedDown} km/h. If the total journey (uphill and downhill) took ${formatDecimal(totalTime,1)} hours, what is the distance to the destination (one way)?`;
                const solutionStepsHTML = `
                    <p>Let D be the one-way distance to the destination in km.</p>
                    <p><strong>Step 1: Express time taken for each part of the journey.</strong></p>
                    <p>Time uphill (T<sub>up</sub>) = Distance / Speed<sub>up</sub> = D / ${speedUp} hours.</p>
                    <p>Time downhill (T<sub>down</sub>) = Distance / Speed<sub>down</sub> = D / ${speedDown} hours.</p>
                    <p><strong>Step 2: Use the total time to form an equation.</strong></p>
                    <p>Total time = T<sub>up</sub> + T<sub>down</sub> = ${formatDecimal(totalTime,1)} hours.</p>
                    <p>So, ${formatFractionHTML('D',speedUp)} + ${formatFractionHTML('D',speedDown)} = ${formatDecimal(totalTime,1)}.</p>
                    <p><strong>Step 3: Solve the equation for D.</strong></p>
                    <p>D(${formatFractionHTML(1,speedUp)} + ${formatFractionHTML(1,speedDown)}) = ${formatDecimal(totalTime,1)}</p>
                    <p>D(${formatFractionHTML(speedDown + speedUp, speedUp * speedDown, false)}) = ${formatDecimal(totalTime,1)}</p>
                    <p>D = ${formatDecimal(totalTime,1)} × ${formatFractionHTML(speedUp * speedDown, speedUp + speedDown, false)}</p>
                    <p>D = ${formatDecimal(oneWayDistance)} km.</p>
                    <p class="final-answer">Final Answer: ${formatDecimal(oneWayDistance)} km</p>
                `;
                return { problemText, solutionStepsHTML };
            },
            
            // Problem 5: Average of consecutive odd integers
            function generateConsecutiveOddProblem() {
                const middleOdd = getRandomInt(5, 20) * 2 + 1; 
                const int1 = middleOdd - 2;
                const int2 = middleOdd;
                const int3 = middleOdd + 2;
                const average = middleOdd; 
                const x = int1;
                const y = int3;
                const productXY = x * y;

                const problemText = `The average of three consecutive distinct positive odd integers is ${average}. If the smallest of these integers is denoted by 'x', and the largest is denoted by 'y', what is the product of x and y?`;
                const solutionStepsHTML = `
                    <p>Let the three consecutive distinct positive odd integers be n, n+2, and n+4.</p>
                    <p><strong>Step 1: Use the average to find the integers.</strong></p>
                    <p>Since they are consecutive and there are three, the average is the middle integer.</p>
                    <p>Middle integer (n+2) = ${average}.</p>
                    <p>So, n = ${average} - 2 = ${int1}.</p>
                    <p>The three integers are ${int1}, ${int1}+2=${int2}, and ${int1}+4=${int3}.</p>
                    <p><strong>Step 2: Identify 'x' and 'y'.</strong></p>
                    <p>The smallest integer (x) = ${x}.</p>
                    <p>The largest integer (y) = ${y}.</p>
                    <p><strong>Step 3: Calculate the product of x and y.</strong></p>
                    <p>Product = x × y = ${x} × ${y} = ${productXY}.</p>
                    <p class="final-answer">Final Answer: ${productXY}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 6: Percentage change in area of rectangle
            function generateRectangleAreaChangeProblem() {
                const widthMultiplier = getRandomInt(2, 4); 
                const lengthIncreasePercent = getRandomInt(1, 3) * 10; 
                const widthDecreasePercent = getRandomInt(1, 2) * 10; 

                const originalLengthFactor = widthMultiplier; 
                const originalAreaFactor = widthMultiplier; 

                const newLengthFactor = originalLengthFactor * (1 + lengthIncreasePercent / 100);
                const newWidthFactor = 1 * (1 - widthDecreasePercent / 100); 

                const newAreaFactor = newLengthFactor * newWidthFactor;
                const areaChangeFactor = newAreaFactor - originalAreaFactor;
                const percentageChange = (areaChangeFactor / originalAreaFactor) * 100;
                const changeType = percentageChange >= 0 ? "increase" : "decrease";

                const problemText = `The length of a rectangle is ${widthMultiplier === 2 ? "twice" : widthMultiplier + " times"} its width. If the length is increased by ${lengthIncreasePercent}% and the width is decreased by ${widthDecreasePercent}%, what is the percentage change in the area of the rectangle?`;
                const solutionStepsHTML = `
                    <p>Let the original width be W. Then the original length L = ${originalLengthFactor}W.</p>
                    <p><strong>Step 1: Calculate the original area.</strong></p>
                    <p>Original Area (A<sub>1</sub>) = L × W = (${originalLengthFactor}W) × W = ${originalAreaFactor}W<sup>2</sup>.</p>
                    <p><strong>Step 2: Calculate the new dimensions.</strong></p>
                    <p>New Length (L') = L × (1 + ${lengthIncreasePercent}/100) = ${originalLengthFactor}W × ${formatDecimal(1 + lengthIncreasePercent/100,2)} = ${formatDecimal(newLengthFactor,2)}W.</p>
                    <p>New Width (W') = W × (1 - ${widthDecreasePercent}/100) = W × ${formatDecimal(1 - widthDecreasePercent/100,2)} = ${formatDecimal(newWidthFactor,2)}W.</p>
                    <p><strong>Step 3: Calculate the new area.</strong></p>
                    <p>New Area (A<sub>2</sub>) = L' × W' = (${formatDecimal(newLengthFactor,2)}W) × (${formatDecimal(newWidthFactor,2)}W) = ${formatDecimal(newAreaFactor,4)}W<sup>2</sup>.</p>
                    <p><strong>Step 4: Calculate the change in area.</strong></p>
                    <p>Change in Area = A<sub>2</sub> - A<sub>1</sub> = ${formatDecimal(newAreaFactor,4)}W<sup>2</sup> - ${originalAreaFactor}W<sup>2</sup> = ${formatDecimal(areaChangeFactor,4)}W<sup>2</sup>.</p>
                    <p><strong>Step 5: Calculate the percentage change in area.</strong></p>
                    <p>Percentage Change = (Change in Area / Original Area) × 100%</p>
                    <p>Percentage Change = (${formatDecimal(areaChangeFactor,4)}W<sup>2</sup> / ${originalAreaFactor}W<sup>2</sup>) × 100%</p>
                    <p>Percentage Change = (${formatDecimal(areaChangeFactor / originalAreaFactor,4)}) × 100% = ${formatDecimal(Math.abs(percentageChange))}%.</p>
                    <p>Since the change is ${percentageChange >= 0 ? "positive" : "negative"}, it's a ${formatDecimal(Math.abs(percentageChange))}% ${changeType}.</p>
                    <p class="final-answer">Final Answer: ${formatDecimal(Math.abs(percentageChange))}% ${changeType}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 7: Mixture of acid solutions
            function generateMixtureProblem() {
                const vol1 = getRandomInt(4, 10);
                
                const conc1_base = getRandomInt(3, 5); 
                const conc1 = conc1_base * 10;
                
                const conc2_max_base = conc1_base - 2; 
                const conc2 = getRandomInt(1, Math.max(1, conc2_max_base)) * 10; 

                const finalConc_min_factor = conc2/10 + 1;
                const finalConc_max_factor = conc1/10 - 1;
                if (finalConc_min_factor > finalConc_max_factor) { 
                    return generateMixtureProblem(); 
                }
                const finalConc = getRandomInt(finalConc_min_factor, finalConc_max_factor) * 10;

                const x_num = vol1 * (conc1 - finalConc);
                const x_den = finalConc - conc2;

                if (x_den === 0) { 
                     return generateMixtureProblem(); 
                }
                const x = x_num / x_den;
                const simplified_x = simplifyFraction(x_num, x_den);

                const problemText = `How many liters of a ${conc2}% acid solution must be added to ${vol1} liters of a ${conc1}% acid solution to obtain a mixture that is a ${finalConc}% acid solution?`;
                const solutionStepsHTML = `
                    <p>Let x be the volume (in liters) of the ${conc2}% acid solution to be added.</p>
                    <p><strong>Step 1: Calculate the amount of acid in each solution.</strong></p>
                    <p>Acid in the ${conc2}% solution = ${formatDecimal(conc2/100,2)} × x = ${formatDecimal(conc2/100,2)}x liters.</p>
                    <p>Acid in the ${vol1} liters of ${conc1}% solution = ${formatDecimal(conc1/100,2)} × ${vol1} = ${formatDecimal((conc1/100)*vol1,2)} liters.</p>
                    <p><strong>Step 2: Set up expressions for the total volume and total acid in the mixture.</strong></p>
                    <p>Total volume of the mixture = x + ${vol1} liters.</p>
                    <p>Total amount of acid in the mixture = ${formatDecimal(conc2/100,2)}x + ${formatDecimal((conc1/100)*vol1,2)} liters.</p>
                    <p><strong>Step 3: Form an equation based on the desired concentration of the mixture.</strong></p>
                    <p>The mixture is to be ${finalConc}% acid. So, (Total acid / Total volume) = ${formatDecimal(finalConc/100,2)}.</p>
                    <p>(${formatDecimal(conc2/100,2)}x + ${formatDecimal((conc1/100)*vol1,2)}) / (x + ${vol1}) = ${formatDecimal(finalConc/100,2)}.</p>
                    <p><strong>Step 4: Solve the equation for x.</strong></p>
                    <p>${formatDecimal(conc2/100,2)}x + ${formatDecimal((conc1/100)*vol1,2)} = ${formatDecimal(finalConc/100,2)}(x + ${vol1})</p>
                    <p>${formatDecimal(conc2/100,2)}x + ${formatDecimal((conc1/100)*vol1,2)} = ${formatDecimal(finalConc/100,2)}x + ${formatDecimal((finalConc/100)*vol1,2)}</p>
                    <p>${formatDecimal((conc1/100)*vol1 - (finalConc/100)*vol1,2)} = (${formatDecimal(finalConc/100,2)} - ${formatDecimal(conc2/100,2)})x</p>
                    <p>${formatDecimal(((conc1 - finalConc)*vol1)/100,2)} = ${formatDecimal((finalConc - conc2)/100,2)}x</p>
                    <p>x = ${formatDecimal((conc1 - finalConc)*vol1,0)} / ${formatDecimal(finalConc - conc2,0)} = ${formatDecimal(x,2)} liters.</p>
                    <p class="final-answer">Final Answer: ${formatFractionHTML(simplified_x.num, simplified_x.den)} liters (or approximately ${formatDecimal(x,2)} liters)</p>
                `;
                return { problemText, solutionStepsHTML };
            },
            
            // Problem 8: Shopkeeper markup and discount
            function generateShopkeeperProblem() {
                const costPrice = getRandomInt(10, 50) * 10; 
                const markupPercent = getRandomInt(3, 8) * 10; 
                const discountPercent = getRandomInt(1, Math.max(1, Math.floor(markupPercent/10)-1)) * 10; 

                const markedPrice = costPrice * (1 + markupPercent / 100);
                const sellingPrice = markedPrice * (1 - discountPercent / 100);
                const finalFactor = (1 + markupPercent/100) * (1 - discountPercent/100);

                const problemText = `A shopkeeper marks an item ${markupPercent}% above its cost price. He then offers a ${discountPercent}% discount on the marked price. If the item sells for $${formatDecimal(sellingPrice)}, what was the original cost price of the item?`;
                const solutionStepsHTML = `
                    <p>Let the Cost Price (CP) be C.</p>
                    <p><strong>Step 1: Calculate the Marked Price (MP).</strong></p>
                    <p>MP = CP × (1 + ${markupPercent}/100) = CP × ${formatDecimal(1 + markupPercent/100,2)}.</p>
                    <p><strong>Step 2: Calculate the Selling Price (SP) after discount.</strong></p>
                    <p>SP = MP × (1 - ${discountPercent}/100) = (CP × ${formatDecimal(1 + markupPercent/100,2)}) × ${formatDecimal(1 - discountPercent/100,2)}.</p>
                    <p>SP = CP × ${formatDecimal(finalFactor,3)}.</p>
                    <p><strong>Step 3: Use the given selling price to find the cost price.</strong></p>
                    <p>SP = $${formatDecimal(sellingPrice)}.</p>
                    <p>CP × ${formatDecimal(finalFactor,3)} = $${formatDecimal(sellingPrice)}.</p>
                    <p>C = $${formatDecimal(sellingPrice)} / ${formatDecimal(finalFactor,3)} = $${formatDecimal(costPrice)}.</p>
                    <p class="final-answer">Final Answer: $${formatDecimal(costPrice)}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 9: Ages ratio problem
            function generateAgesRatioProblem() {
                const ratioA = getRandomInt(2, 4);
                const ratioB = ratioA + getRandomInt(1, 2);
                const x = getRandomInt(3, 7); 
                const yearsAgo = 5; 
                const yearsHence = 5; 

                const sumAgesHence = (ratioA * x + yearsAgo + yearsHence) + (ratioB * x + yearsAgo + yearsHence);
                const benCurrentAgeNum = ratioB * x + yearsAgo;

                const problemText = `${yearsAgo} years ago, the ratio of Anna's age to Ben's age was ${ratioA}:${ratioB}. In ${yearsHence} years from now, the sum of their ages will be ${sumAgesHence}. What is Ben's current age?`;
                const solutionStepsHTML = `
                    <p>Let Anna's age ${yearsAgo} years ago be ${ratioA}x and Ben's age ${yearsAgo} years ago be ${ratioB}x.</p>
                    <p><strong>Step 1: Express their current ages.</strong></p>
                    <p>Anna's current age = ${ratioA}x + ${yearsAgo}.</p>
                    <p>Ben's current age = ${ratioB}x + ${yearsAgo}.</p>
                    <p><strong>Step 2: Express their ages in ${yearsHence} years from now.</strong></p>
                    <p>Anna's age in ${yearsHence} years = (${ratioA}x + ${yearsAgo}) + ${yearsHence} = ${ratioA}x + ${yearsAgo + yearsHence}.</p>
                    <p>Ben's age in ${yearsHence} years = (${ratioB}x + ${yearsAgo}) + ${yearsHence} = ${ratioB}x + ${yearsAgo + yearsHence}.</p>
                    <p><strong>Step 3: Use the sum of their ages in ${yearsHence} years to form an equation.</strong></p>
                    <p>Sum = (${ratioA}x + ${yearsAgo + yearsHence}) + (${ratioB}x + ${yearsAgo + yearsHence}) = ${sumAgesHence}.</p>
                    <p>(${ratioA + ratioB})x + ${2 * (yearsAgo + yearsHence)} = ${sumAgesHence}.</p>
                    <p><strong>Step 4: Solve for x.</strong></p>
                    <p>(${ratioA + ratioB})x = ${sumAgesHence} - ${2 * (yearsAgo + yearsHence)} = ${sumAgesHence - 2 * (yearsAgo + yearsHence)}}.</p>
                    <p>x = ${formatFractionHTML(sumAgesHence - 2 * (yearsAgo + yearsHence), ratioA + ratioB)} = ${x}.</p>
                    <p><strong>Step 5: Calculate Ben's current age.</strong></p>
                    <p>Ben's current age = ${ratioB}x + ${yearsAgo} = ${ratioB} × ${x} + ${yearsAgo} = ${benCurrentAgeNum}.</p>
                    <p class="final-answer">Final Answer: ${benCurrentAgeNum} years</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 10: Pipes filling/emptying cistern
            function generatePipesCisternProblem() {
                let ta, tb, tc, simplifiedCombined;
                let attempts = 0;
                const MAX_ATTEMPTS_PIPES = 100; 
                do {
                    ta = getRandomInt(10, 20); 
                    tb = getRandomInt(ta + 1, ta + 10); 
                    tc = getRandomInt(Math.max(5, Math.min(ta,tb)-5) , Math.max(ta,tb)+5 ); 
                    
                    const combinedNum = (tb * tc) + (ta * tc) - (ta * tb);
                    const combinedDen = ta * tb * tc;

                    if (combinedDen === 0) { 
                         attempts++; continue; 
                    }
                    simplifiedCombined = simplifyFraction(combinedNum, combinedDen);
                    attempts++;
                    if (attempts > MAX_ATTEMPTS_PIPES) { 
                        ta=12; tb=15; tc=10; 
                        simplifiedCombined = simplifyFraction( (15*10 + 12*10 - 12*15), 12*15*10); 
                        break;
                    }
                } while (simplifiedCombined.num <= 0 || simplifiedCombined.den === 0);

                const initialFillNum = 1;
                const initialFillDen = getRandomInt(2, 4); 

                const remainingFillNum = initialFillDen - initialFillNum;
                const remainingFillDen = initialFillDen;

                if (simplifiedCombined.num === 0 || simplifiedCombined.den === 0) { 
                     return { problemText: "Error generating pipe problem (zero rate). Please try again.", solutionStepsHTML: "<p>Could not generate valid parameters.</p>"};
                }

                const timeToFillNum = remainingFillNum * simplifiedCombined.den;
                const timeToFillDen = remainingFillDen * simplifiedCombined.num;
                const simplifiedTimeToFill = simplifyFraction(timeToFillNum, timeToFillDen);
                const timeToFillDecimal = simplifiedTimeToFill.den === 0 ? Infinity : simplifiedTimeToFill.num / simplifiedTimeToFill.den;

                const problemText = `Pipe A can fill a cistern in ${ta} minutes. Pipe B can fill the same cistern in ${tb} minutes. Pipe C can empty the full cistern in ${tc} minutes. If all three pipes are opened simultaneously when the cistern is ${formatFractionHTML(initialFillNum,initialFillDen)} full, how long will it take to fill the cistern?`;
                const solutionStepsHTML = `
                    <p><strong>Step 1: Rates (fraction of cistern per minute).</strong></p>
                    <p>Rate A = +${formatFractionHTML(1, ta)}. Rate B = +${formatFractionHTML(1, tb)}. Rate C = -${formatFractionHTML(1, tc)}.</p>
                    <p><strong>Step 2: Combined rate.</strong></p>
                    <p>Combined rate = ${formatFractionHTML(1, ta)} + ${formatFractionHTML(1, tb)} - ${formatFractionHTML(1, tc)} = ${formatFractionHTML(simplifiedCombined.num, simplifiedCombined.den)} cistern/minute.</p>
                    <p><strong>Step 3: Fraction remaining to fill.</strong></p>
                    <p>Remaining = 1 - ${formatFractionHTML(initialFillNum, initialFillDen)} = ${formatFractionHTML(remainingFillNum, remainingFillDen)}.</p>
                    <p><strong>Step 4: Time to fill remaining part.</strong></p>
                    <p>Time = Work / Rate = ${formatFractionHTML(remainingFillNum, remainingFillDen)} / ${formatFractionHTML(simplifiedCombined.num, simplifiedCombined.den)} = ${formatFractionHTML(simplifiedTimeToFill.num, simplifiedTimeToFill.den)} minutes.</p>
                    <p class="final-answer">Final Answer: ${formatFractionHTML(simplifiedTimeToFill.num, simplifiedTimeToFill.den)} minutes (approx. ${formatDecimal(timeToFillDecimal)} minutes)</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 11: Average score change
            function generateAverageScoreProblem() {
                const numStudents = getRandomInt(20, 40);
                const originalAverage = getRandomInt(60, 85);
                const scoreLeft = getRandomInt(Math.max(30, originalAverage-20), originalAverage + 5); 
                const newAverageIncrease = getRandomInt(1, 3); 
                const newAverage = originalAverage + newAverageIncrease;

                const originalTotalScore = numStudents * originalAverage;
                const totalScoreAfterLeft = originalTotalScore - scoreLeft;
                const newTotalScore = numStudents * newAverage; 
                const scoreNewStudent = newTotalScore - totalScoreAfterLeft;

                const problemText = `The average score of a class of ${numStudents} students on a test was ${originalAverage}. After one student who scored ${scoreLeft} left the class, and a new student joined, the new average score of the class (which still has ${numStudents} students) became ${newAverage}. What was the score of the new student?`;
                const solutionStepsHTML = `
                    <p><strong>Step 1: Original total score.</strong></p>
                    <p>${numStudents} × ${originalAverage} = ${originalTotalScore}.</p>
                    <p><strong>Step 2: Total score after one student left.</strong></p>
                    <p>${originalTotalScore} - ${scoreLeft} = ${totalScoreAfterLeft} (for ${numStudents -1} students).</p>
                    <p><strong>Step 3: New total score with new student.</strong></p>
                    <p>${numStudents} × ${newAverage} = ${newTotalScore}.</p>
                    <p><strong>Step 4: Score of the new student.</strong></p>
                    <p>New Student Score = New Total - Total of remaining students = ${newTotalScore} - ${totalScoreAfterLeft} = ${scoreNewStudent}.</p>
                    <p class="final-answer">Final Answer: ${scoreNewStudent}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 12: Combined ratios a:d
            function generateCombinedRatiosProblem() {
                const a_b_num = getRandomInt(1, 4);
                const a_b_den = getRandomInt(a_b_num + 1, 5);
                const b_c_num = getRandomInt(1, 4);
                const b_c_den = getRandomInt(b_c_num + 1, 5);
                const c_d_num = getRandomInt(1, 4);
                const c_d_den = getRandomInt(c_d_num + 1, 5);

                const ad_num = a_b_num * b_c_num * c_d_num;
                const ad_den = a_b_den * b_c_den * c_d_den;
                const simplified_ad = simplifyFraction(ad_num, ad_den);

                const problemText = `Given the ratios a:b = ${a_b_num}:${a_b_den}, b:c = ${b_c_num}:${b_c_den}, and c:d = ${c_d_num}:${c_d_den}, what is the ratio a:d?`;
                const solutionStepsHTML = `
                    <p>${formatFractionHTML('a','b')} = ${formatFractionHTML(a_b_num,a_b_den)}, ${formatFractionHTML('b','c')} = ${formatFractionHTML(b_c_num,b_c_den)}, ${formatFractionHTML('c','d')} = ${formatFractionHTML(c_d_num,c_d_den)}</p>
                    <p><strong>Step 1: Multiply fractions for a:d.</strong></p>
                    <p>${formatFractionHTML('a','d')} = ${formatFractionHTML(a_b_num,a_b_den)} × ${formatFractionHTML(b_c_num,b_c_den)} × ${formatFractionHTML(c_d_num,c_d_den)}</p>
                    <p><strong>Step 2: Perform multiplication.</strong></p>
                    <p>${formatFractionHTML('a','d')} = ${formatFractionHTML(ad_num, ad_den, false)}</p>
                    <p><strong>Step 3: Simplify.</strong></p>
                    <p>${formatFractionHTML('a','d')} = ${formatFractionHTML(simplified_ad.num, simplified_ad.den)}.</p>
                    <p class="final-answer">Final Answer: ${simplified_ad.num}:${simplified_ad.den}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 13: Train speed quadratic equation
            function generateTrainSpeedProblem() {
                let originalSpeed, speedIncrease, originalTime, distance, newSpeed, newTime, timeSaved;
                let attempts = 0;
                const MAX_ATTEMPTS_TRAIN = 100;

                do {
                    originalSpeed = getRandomInt(20, 70); 
                    speedIncrease = getRandomInt(5, 25); 
                    originalTime = getRandomInt(4, 20); 

                    distance = originalSpeed * originalTime;
                    newSpeed = originalSpeed + speedIncrease;
                    
                    if (distance <= 0 || newSpeed <= 0 || distance % newSpeed !== 0) { 
                        attempts++;
                        if (attempts > MAX_ATTEMPTS_TRAIN) { 
                            originalSpeed=30; speedIncrease=10; originalTime=12; 
                            distance = 360; newSpeed = 40;
                        }
                        continue;
                    }
                    newTime = distance / newSpeed;
                    timeSaved = originalTime - newTime;
                    attempts++;
                     if (attempts > MAX_ATTEMPTS_TRAIN) { 
                        originalSpeed=30; speedIncrease=10; originalTime=12; distance = 360; newSpeed = 40; timeSaved = 3; break;
                    }
                } while (timeSaved <= 0 || !Number.isInteger(timeSaved) || timeSaved > Math.floor(originalTime * 0.85) || timeSaved < 1 ); 
                
                const coeff_a = timeSaved;
                const coeff_b = speedIncrease * timeSaved;
                const coeff_c = -1 * speedIncrease * distance;
                const common_divisor = gcd(gcd(Math.abs(coeff_a),Math.abs(coeff_b)),Math.abs(coeff_c));
                const simplified_a = coeff_a / common_divisor;
                const simplified_b = coeff_b / common_divisor;
                const simplified_c = coeff_c / common_divisor;

                const problemText = `A train is scheduled to cover a distance of ${distance} km at a uniform speed. If its speed were ${speedIncrease} km/h more than planned, it would have taken ${timeSaved} hours less for the journey. What is the original planned speed of the train?`;
                const solutionStepsHTML = `
                    <p>Let original speed be S km/h, original time T hours. Distance D = ${distance} km.</p>
                    <p>D = S × T  => T = ${distance}/S.</p>
                    <p>New speed = S + ${speedIncrease}, New time = T - ${timeSaved}.</p>
                    <p>D = (S + ${speedIncrease})(T - ${timeSaved}).</p>
                    <p>Substitute T: ${distance} = (S + ${speedIncrease})(${formatFractionHTML(distance,'S')} - ${timeSaved}).</p>
                    <p>Multiply by S: ${distance}S = (S + ${speedIncrease})(${distance} - ${timeSaved}S).</p>
                    <p>${distance}S = ${distance}S - ${timeSaved}S<sup>2</sup> + ${speedIncrease*distance} - ${speedIncrease*timeSaved}S.</p>
                    <p>0 = -${timeSaved}S<sup>2</sup> - ${speedIncrease*timeSaved}S + ${speedIncrease*distance}.</p>
                    <p>Simplified: ${simplified_a}S<sup>2</sup> + ${simplified_b}S + ${simplified_c} = 0.</p>
                    <p>Factoring or using quadratic formula gives S = ${originalSpeed} (positive solution).</p>
                    <p class="final-answer">Final Answer: ${originalSpeed} km/h</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 14: Price increase then decrease by x%
            function generatePriceChangeXPercentProblem() {
                const x = getRandomInt(1, 4) * 5; // 5, 10, 15, 20%
                const originalPrice = 100; 

                const priceAfterIncrease = originalPrice * (1 + x/100);
                const finalPrice = priceAfterIncrease * (1 - x/100);
                const finalPricePercentage = (finalPrice / originalPrice) * 100;

                const problemText = `The price of an item was first increased by x%. Later, the new price was decreased by x%. If the final price was ${formatDecimal(finalPricePercentage)}% of the original price, what is the value of x?`;
                const solutionStepsHTML = `
                    <p>Let original price be P.</p>
                    <p>After x% increase: P(1 + x/100).</p>
                    <p>After x% decrease on new price: P(1 + x/100)(1 - x/100).</p>
                    <p>This equals ${formatDecimal(finalPricePercentage/100, 4)}P.</p>
                    <p>(1 + x/100)(1 - x/100) = ${formatDecimal(finalPricePercentage/100, 4)}.</p>
                    <p>1 - (x/100)<sup>2</sup> = ${formatDecimal(finalPricePercentage/100, 4)}.</p>
                    <p>(x/100)<sup>2</sup> = 1 - ${formatDecimal(finalPricePercentage/100, 4)} = ${formatDecimal(1 - finalPricePercentage/100, 4)}.</p>
                    <p>x<sup>2</sup>/10000 = ${formatDecimal(1 - finalPricePercentage/100, 4)}.</p>
                    <p>x<sup>2</sup> = ${formatDecimal((1 - finalPricePercentage/100) * 10000, 0)}.</p>
                    <p>x = √${formatDecimal((1 - finalPricePercentage/100) * 10000, 0)} = ${x}.</p>
                    <p class="final-answer">Final Answer: ${x}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 15: Boat upstream/downstream
            function generateBoatStreamProblem() {
                let boatSpeed, streamSpeed, speedUpstream, speedDownstream, timeUpstream, distance, timeDownstream;
                let attempts = 0;
                const MAX_ATTEMPTS_BOAT = 100;
                do {
                    boatSpeed = getRandomInt(5, 20); 
                    streamSpeed = getRandomInt(1, Math.max(1, boatSpeed - 2)); 

                    speedUpstream = boatSpeed - streamSpeed;
                    speedDownstream = boatSpeed + streamSpeed;

                    timeUpstream = getRandomInt(2, 6);
                    distance = speedUpstream * timeUpstream;
                    
                    if (speedDownstream <= 0 || distance <=0 || distance % speedDownstream !== 0) {
                         attempts++;
                         if(attempts > MAX_ATTEMPTS_BOAT) { boatSpeed=6; streamSpeed=2; timeUpstream=6; distance=24; speedDownstream=8;} // Failsafe
                         continue;
                    }
                    timeDownstream = distance / speedDownstream;
                    attempts++;
                    if(attempts > MAX_ATTEMPTS_BOAT) { boatSpeed=6; streamSpeed=2; timeUpstream=6; distance=24; speedDownstream=8; timeDownstream=3; break;}
                } while (timeDownstream <=0 || !Number.isInteger(timeDownstream));


                const problemText = `A boat travels ${distance} km upstream in ${timeUpstream} hours. It travels the same distance (${distance} km) downstream in ${formatDecimal(timeDownstream)} hours. What is the speed of the boat in still water and the speed of the stream?`;
                const solutionStepsHTML = `
                    <p>Let B = boat speed in still water, S = stream speed.</p>
                    <p>Upstream speed = B - S. Downstream speed = B + S.</p>
                    <p>Upstream: ${distance} = (B - S) × ${timeUpstream}  => B - S = ${speedUpstream} (Eq 1)</p>
                    <p>Downstream: ${distance} = (B + S) × ${formatDecimal(timeDownstream)} => B + S = ${speedDownstream} (Eq 2)</p>
                    <p>Add (Eq 1) + (Eq 2): 2B = ${speedUpstream + speedDownstream} => B = ${boatSpeed} km/h.</p>
                    <p>Substitute B in (Eq 2): ${boatSpeed} + S = ${speedDownstream} => S = ${streamSpeed} km/h.</p>
                    <p class="final-answer">Final Answer: Boat speed = ${boatSpeed} km/h, Stream speed = ${streamSpeed} km/h</p>
                `;
                return { problemText, solutionStepsHTML };
            }
        ];
        
        // --- Problem Generator Functions (New Set) ---
        const problemGenerators_Set2 = [
            // Problem 16: Pythagorean Theorem with Area/Perimeter
            function generatePythagoreanAreaProblem() {
                // Using Pythagorean triples: (3,4,5), (5,12,13), (8,15,17), (7,24,25)
                const triples = [[3,4,5], [5,12,13], [8,15,17], [7,24,25]];
                const chosenTriple = triples[getRandomInt(0, triples.length - 1)];
                const multiplier = getRandomInt(1, 3);
                const sideA = chosenTriple[0] * multiplier;
                const sideB = chosenTriple[1] * multiplier;
                const diagonal = chosenTriple[2] * multiplier;
                
                const perimeter = 2 * (sideA + sideB);
                const area = sideA * sideB;
                const costPerMeter = getRandomInt(3, 10);
                const totalCost = perimeter * costPerMeter;

                const problemText = `A rectangular field has a length of ${sideA} meters and a diagonal of ${diagonal} meters. What is the width of the field? If fencing costs $${costPerMeter} per meter, what is the total cost to fence the field?`;
                const solutionStepsHTML = `
                    <p>Let length L = ${sideA}m, diagonal D = ${diagonal}m, width W.</p>
                    <p><strong>Step 1: Find the width using Pythagorean theorem.</strong></p>
                    <p>L<sup>2</sup> + W<sup>2</sup> = D<sup>2</sup></p>
                    <p>${sideA}<sup>2</sup> + W<sup>2</sup> = ${diagonal}<sup>2</sup></p>
                    <p>${sideA*sideA} + W<sup>2</sup> = ${diagonal*diagonal}</p>
                    <p>W<sup>2</sup> = ${diagonal*diagonal} - ${sideA*sideA} = ${diagonal*diagonal - sideA*sideA}</p>
                    <p>W = √${diagonal*diagonal - sideA*sideA} = ${sideB} meters.</p>
                    <p><strong>Step 2: Calculate the perimeter.</strong></p>
                    <p>Perimeter = 2(L + W) = 2(${sideA} + ${sideB}) = 2(${sideA+sideB}) = ${perimeter} meters.</p>
                    <p><strong>Step 3: Calculate the total cost to fence.</strong></p>
                    <p>Total Cost = Perimeter × Cost per meter = ${perimeter} m × $${costPerMeter}/m = $${totalCost}.</p>
                    <p class="final-answer">Final Answer: Width = ${sideB}m, Total Cost = $${totalCost}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 17: Volume of Cylinder and Filling Time
            function generateCylinderVolumeProblem() {
                const radius = getRandomInt(1, 3); // meters
                const height = getRandomInt(4, 8); // meters
                const initialFillNum = getRandomInt(1,3);
                const initialFillDen = initialFillNum + getRandomInt(1,2); // e.g., 1/2, 1/3, 2/3, 1/4, 2/4, 3/4
                
                const totalVolume = Math.PI * radius * radius * height;
                const initialVolume = totalVolume * (initialFillNum / initialFillDen);
                const volumeToFill = totalVolume - initialVolume;
                const flowRate = getRandomInt(1,5) * 0.1; // 0.1 to 0.5 cubic meters per minute

                const timeToFillMinutes = volumeToFill / flowRate;

                const problemText = `A cylindrical water tank has a radius of ${radius} meters and a height of ${height} meters. It is currently ${formatFractionHTML(initialFillNum, initialFillDen)} full. How many cubic meters of water (to 2 decimal places, use π ≈ 3.14159) are needed to fill it completely? If water flows in at ${formatDecimal(flowRate,1)} cubic meters per minute, how long will this take (to 1 decimal place)?`;
                const solutionStepsHTML = `
                    <p>Use π ≈ 3.14159.</p>
                    <p><strong>Step 1: Calculate the total volume of the cylinder.</strong></p>
                    <p>Total Volume (V) = π × r<sup>2</sup> × h = π × ${radius}<sup>2</sup> × ${height} = π × ${radius*radius} × ${height} = ${formatDecimal(totalVolume, 2)} m<sup>3</sup>.</p>
                    <p><strong>Step 2: Calculate the volume of water already in the tank.</strong></p>
                    <p>Initial Volume = Total Volume × ${formatFractionHTML(initialFillNum, initialFillDen)} = ${formatDecimal(totalVolume, 2)} × ${formatDecimal(initialFillNum/initialFillDen,3)} = ${formatDecimal(initialVolume, 2)} m<sup>3</sup>.</p>
                    <p><strong>Step 3: Calculate the volume of water needed to fill it.</strong></p>
                    <p>Volume to Fill = Total Volume - Initial Volume = ${formatDecimal(totalVolume, 2)} - ${formatDecimal(initialVolume, 2)} = ${formatDecimal(volumeToFill, 2)} m<sup>3</sup>.</p>
                    <p><strong>Step 4: Calculate the time to fill.</strong></p>
                    <p>Time = Volume to Fill / Flow Rate = ${formatDecimal(volumeToFill, 2)} m<sup>3</sup> / ${formatDecimal(flowRate,1)} m<sup>3</sup>/min = ${formatDecimal(timeToFillMinutes,1)} minutes.</p>
                    <p class="final-answer">Final Answer: Water needed ≈ ${formatDecimal(volumeToFill, 2)} m<sup>3</sup>, Time ≈ ${formatDecimal(timeToFillMinutes,1)} minutes</p>
                `;
                return { problemText, solutionStepsHTML };
            },
            
            // Problem 18: Similar Figures (Shadows)
            function generateShadowProblem() {
                const personHeight = getRandomInt(15, 20) / 10; // 1.5 to 2.0 meters
                const personShadow = personHeight * (getRandomInt(10, 15) / 10); // Shadow longer or shorter
                const treeShadowMultiplier = getRandomInt(3, 6);
                const treeShadow = personShadow * treeShadowMultiplier;

                const treeHeight = (personHeight * treeShadow) / personShadow;
                // Add a second part:
                const diameterFractionDen = getRandomInt(15, 25);
                const treeDiameter = treeHeight / diameterFractionDen;


                const problemText = `A ${formatDecimal(personHeight,1)}-meter tall person casts a ${formatDecimal(personShadow,1)}-meter shadow. At the same time, a nearby tree casts a ${formatDecimal(treeShadow,1)}-meter shadow. How tall is the tree? If the tree's diameter is ${formatFractionHTML(1, diameterFractionDen)} of its height, what is its approximate diameter (to 2 decimal places)?`;
                const solutionStepsHTML = `
                    <p><strong>Step 1: Set up the proportion for similar triangles (height/shadow).</strong></p>
                    <p>${formatFractionHTML('Person Height', 'Person Shadow')} = ${formatFractionHTML('Tree Height', 'Tree Shadow')}</p>
                    <p>${formatFractionHTML(formatDecimal(personHeight,1), formatDecimal(personShadow,1))} = ${formatFractionHTML('Tree Height', formatDecimal(treeShadow,1))}</p>
                    <p><strong>Step 2: Solve for Tree Height.</strong></p>
                    <p>Tree Height = (${formatDecimal(personHeight,1)} × ${formatDecimal(treeShadow,1)}) / ${formatDecimal(personShadow,1)} = ${formatDecimal(treeHeight,1)} meters.</p>
                    <p><strong>Step 3: Calculate the tree's diameter.</strong></p>
                    <p>Diameter = Tree Height / ${diameterFractionDen} = ${formatDecimal(treeHeight,1)} / ${diameterFractionDen} = ${formatDecimal(treeDiameter,2)} meters.</p>
                    <p class="final-answer">Final Answer: Tree Height = ${formatDecimal(treeHeight,1)} m, Diameter ≈ ${formatDecimal(treeDiameter,2)} m</p>
                `;
                return { problemText, solutionStepsHTML };
            },
            
            // Problem 19: LCM (Coinciding Events - Gears)
            function generateLcmGearsProblem() {
                const teethA = getRandomInt(3, 5) * 6; // e.g., 18, 24, 30
                const teethB = getRandomInt(2, 4) * 6; // e.g., 12, 18, 24 (ensure different from A)
                if (teethA === teethB) return generateLcmGearsProblem(); // Recurse if same

                const lcmTeeth = lcm(teethA, teethB);
                const revsA = lcmTeeth / teethA;
                const revsB = lcmTeeth / teethB;
                
                const largerGearTeeth = Math.max(teethA, teethB);
                const revsLarger = largerGearTeeth === teethA ? revsA : revsB;

                const problemText = `Two gears mesh. Gear A has ${teethA} teeth and Gear B has ${teethB} teeth. If a marked tooth on each gear starts aligned at the bottom, how many revolutions must the gear with ${largerGearTeeth} teeth make before the marked teeth align again at the bottom?`;
                const solutionStepsHTML = `
                    <p><strong>Step 1: Find the Least Common Multiple (LCM) of the number of teeth.</strong></p>
                    <p>The marked teeth will align again after a number of teeth equal to the LCM(${teethA}, ${teethB}) has passed the mesh point for both gears.</p>
                    <p>LCM(${teethA}, ${teethB}) = ${lcmTeeth}.</p>
                    <p>This means ${lcmTeeth} "tooth positions" must pass.</p>
                    <p><strong>Step 2: Calculate revolutions for each gear.</strong></p>
                    <p>Revolutions for Gear A = LCM / Teeth in A = ${lcmTeeth} / ${teethA} = ${revsA} revolutions.</p>
                    <p>Revolutions for Gear B = LCM / Teeth in B = ${lcmTeeth} / ${teethB} = ${revsB} revolutions.</p>
                    <p><strong>Step 3: Identify revolutions for the specified gear.</strong></p>
                    <p>The gear with ${largerGearTeeth} teeth is ${largerGearTeeth === teethA ? "Gear A" : "Gear B"}.</p>
                    <p>It will make ${revsLarger} revolutions.</p>
                    <p class="final-answer">Final Answer: ${revsLarger} revolutions</p>
                `;
                return { problemText, solutionStepsHTML };
            },
            
            // Problem 20: Digit Problems (Two-digit numbers)
            function generateDigitProblem() {
                let tens, ones, sumDigits, diffReversed;
                let originalNum, reversedNum;
                let attempts = 0;
                do { // Ensure originalNum > reversedNum and diff is nice
                    tens = getRandomInt(1, 9);
                    ones = getRandomInt(0, 9);
                    while (tens === ones) ones = getRandomInt(0, 9); // Ensure digits are different for more interesting diff

                    originalNum = tens * 10 + ones;
                    reversedNum = ones * 10 + tens;
                    sumDigits = tens + ones;
                    diffReversed = Math.abs(originalNum - reversedNum);
                    attempts++;
                    if (attempts > 50) { // Failsafe
                        tens=7; ones=2; originalNum=72; reversedNum=27; sumDigits=9; diffReversed=45; break;
                    }
                } while (diffReversed === 0 || diffReversed % 9 !== 0 || originalNum <= reversedNum); // diffReversed must be multiple of 9

                const problemText = `The sum of the digits of a two-digit number is ${sumDigits}. If the digits are reversed, the new number is ${diffReversed} less than the original number. Find the original number.`;
                const solutionStepsHTML = `
                    <p>Let the two-digit number be 10t + u, where t is the tens digit and u is the units digit.</p>
                    <p><strong>Step 1: Formulate equations from the given information.</strong></p>
                    <p>Sum of digits: t + u = ${sumDigits} (Equation 1)</p>
                    <p>Original number: 10t + u</p>
                    <p>Reversed number: 10u + t</p>
                    <p>Original - Reversed = ${diffReversed}</p>
                    <p>(10t + u) - (10u + t) = ${diffReversed}</p>
                    <p>9t - 9u = ${diffReversed}</p>
                    <p>t - u = ${diffReversed / 9} (Equation 2)</p>
                    <p><strong>Step 2: Solve the system of equations.</strong></p>
                    <p>1)  t + u = ${sumDigits}</p>
                    <p>2)  t - u = ${diffReversed / 9}</p>
                    <p>Add (1) and (2): 2t = ${sumDigits + (diffReversed / 9)} => 2t = ${tens*2} => t = ${tens}.</p>
                    <p>Substitute t into (1): ${tens} + u = ${sumDigits} => u = ${sumDigits - tens} = ${ones}.</p>
                    <p><strong>Step 3: Form the original number.</strong></p>
                    <p>Original number = 10t + u = 10(${tens}) + ${ones} = ${originalNum}.</p>
                    <p><em>Check: Reversed = ${reversedNum}. ${originalNum} - ${reversedNum} = ${diffReversed}. Correct.</em></p>
                    <p class="final-answer">Final Answer: ${originalNum}</p>
                `;
                return { problemText, solutionStepsHTML };
            },
            
            // Problem 21: Multi-Step Probability (Without Replacement)
            function generateProbabilityProblem() {
                const redMarbles = getRandomInt(3, 6);
                const blueMarbles = getRandomInt(2, 5);
                const totalMarbles = redMarbles + blueMarbles;

                // Prob of 2 red: (red/total) * ((red-1)/(total-1))
                const prob2RedNum = redMarbles * (redMarbles - 1);
                const prob2RedDen = totalMarbles * (totalMarbles - 1);
                const simplifiedProb2Red = simplifyFraction(prob2RedNum, prob2RedDen);

                // Prob of 1 red then 1 blue: (red/total) * (blue/(total-1))
                // Prob of 1 blue then 1 red: (blue/total) * (red/(total-1))
                // Prob of one of each = P(RB) + P(BR)
                const probOneEachNum = (redMarbles * blueMarbles) + (blueMarbles * redMarbles) ;
                const probOneEachDen = totalMarbles * (totalMarbles - 1);
                const simplifiedProbOneEach = simplifyFraction(probOneEachNum, probOneEachDen);


                const problemText = `A bag contains ${redMarbles} red marbles and ${blueMarbles} blue marbles. Two marbles are drawn without replacement. What is the probability that both marbles are red? What is the probability of drawing one of each color?`;
                const solutionStepsHTML = `
                    <p>Total marbles = ${redMarbles} (red) + ${blueMarbles} (blue) = ${totalMarbles}.</p>
                    <p><strong>Part 1: Probability of both marbles being red (RR).</strong></p>
                    <p>P(1st is red) = ${formatFractionHTML(redMarbles, totalMarbles)}.</p>
                    <p>After drawing 1 red, there are ${redMarbles-1} red and ${totalMarbles-1} total marbles left.</p>
                    <p>P(2nd is red | 1st was red) = ${formatFractionHTML(redMarbles-1, totalMarbles-1)}.</p>
                    <p>P(RR) = P(1st red) × P(2nd red | 1st red) = ${formatFractionHTML(redMarbles, totalMarbles)} × ${formatFractionHTML(redMarbles-1, totalMarbles-1)} = ${formatFractionHTML(prob2RedNum, prob2RedDen,false)} = ${formatFractionHTML(simplifiedProb2Red.num, simplifiedProb2Red.den)}.</p>
                    
                    <p><strong>Part 2: Probability of drawing one of each color (RB or BR).</strong></p>
                    <p>Case 1: Red then Blue (RB)</p>
                    <p>P(RB) = P(1st red) × P(2nd blue | 1st red) = ${formatFractionHTML(redMarbles, totalMarbles)} × ${formatFractionHTML(blueMarbles, totalMarbles-1)} = ${formatFractionHTML(redMarbles*blueMarbles, totalMarbles*(totalMarbles-1), false)}.</p>
                    <p>Case 2: Blue then Red (BR)</p>
                    <p>P(BR) = P(1st blue) × P(2nd red | 1st blue) = ${formatFractionHTML(blueMarbles, totalMarbles)} × ${formatFractionHTML(redMarbles, totalMarbles-1)} = ${formatFractionHTML(blueMarbles*redMarbles, totalMarbles*(totalMarbles-1), false)}.</p>
                    <p>P(one of each) = P(RB) + P(BR) = ${formatFractionHTML(redMarbles*blueMarbles, totalMarbles*(totalMarbles-1), false)} + ${formatFractionHTML(blueMarbles*redMarbles, totalMarbles*(totalMarbles-1), false)} = ${formatFractionHTML(probOneEachNum, probOneEachDen, false)} = ${formatFractionHTML(simplifiedProbOneEach.num, simplifiedProbOneEach.den)}.</p>
                    <p class="final-answer">Final Answer: P(both red) = ${formatFractionHTML(simplifiedProb2Red.num, simplifiedProb2Red.den)}, P(one of each) = ${formatFractionHTML(simplifiedProbOneEach.num, simplifiedProbOneEach.den)}</p>
                `;
                return { problemText, solutionStepsHTML };
            },

            // Problem 22: Venn Diagrams / Set Theory (Two Sets)
            function generateVennDiagramProblem() {
                const totalSurveyed = getRandomInt(80, 150);
                const likesAOnly = getRandomInt(10, Math.floor(totalSurveyed * 0.3));
                const likesBOnly = getRandomInt(10, Math.floor(totalSurveyed * 0.3));
                const likesBoth = getRandomInt(5, Math.floor(totalSurveyed * 0.2));
                
                const likesA = likesAOnly + likesBoth;
                const likesB = likesBOnly + likesBoth;
                const likesEitherOrBoth = likesAOnly + likesBOnly + likesBoth;
                const likesNeither = totalSurveyed - likesEitherOrBoth;

                if (likesNeither < 0) return generateVennDiagramProblem(); // Ensure valid numbers

                const percentALikesB = likesBoth > 0 && likesA > 0 ? (likesBoth / likesA) * 100 : 0;

                const problemText = `In a survey of ${totalSurveyed} students, ${likesA} like Math, ${likesB} like Science, and ${likesBoth} like both Math and Science. How many students like neither Math nor Science? What percentage of students who like Math also like Science (to 1 decimal place)?`;
                const solutionStepsHTML = `
                    <p>Total students = ${totalSurveyed}.</p>
                    <p>Likes Math (M) = ${likesA}. Likes Science (S) = ${likesB}. Likes Both (M ∩ S) = ${likesBoth}.</p>
                    <p><strong>Step 1: Find the number of students who like Math only.</strong></p>
                    <p>Likes Math only = Likes Math - Likes Both = ${likesA} - ${likesBoth} = ${likesAOnly}.</p>
                    <p><strong>Step 2: Find the number of students who like Science only.</strong></p>
                    <p>Likes Science only = Likes Science - Likes Both = ${likesB} - ${likesBoth} = ${likesBOnly}.</p>
                    <p><strong>Step 3: Find the number of students who like at least one subject.</strong></p>
                    <p>Likes Math or Science or Both (M ∪ S) = Likes Math only + Likes Science only + Likes Both</p>
                    <p>= ${likesAOnly} + ${likesBOnly} + ${likesBoth} = ${likesEitherOrBoth}.</p>
                    <p><em>Alternatively: M ∪ S = M + S - (M ∩ S) = ${likesA} + ${likesB} - ${likesBoth} = ${likesEitherOrBoth}.</em></p>
                    <p><strong>Step 4: Find the number of students who like neither.</strong></p>
                    <p>Likes Neither = Total - Likes Math or Science or Both = ${totalSurveyed} - ${likesEitherOrBoth} = ${likesNeither}.</p>
                    <p><strong>Step 5: Percentage of Math-likers who also like Science.</strong></p>
                    <p>P(Likes Science | Likes Math) = (Likes Both / Likes Math) × 100%</p>
                    <p>= (${likesBoth} / ${likesA}) × 100% = ${formatDecimal(percentALikesB, 1)}%.</p>
                    <p class="final-answer">Final Answer: Likes Neither = ${likesNeither}, Percentage = ${formatDecimal(percentALikesB, 1)}%</p>
                `;
                return { problemText, solutionStepsHTML };
            },
            
            // Problem 23: Compound Interest (Annual)
            function generateCompoundInterestProblem() {
                const principal = getRandomInt(5, 20) * 100; // $500 to $2000
                const ratePercent = getRandomInt(3, 8); // 3% to 8%
                const years = getRandomInt(2, 4);
                const withdrawalPercent = getRandomInt(1,3) * 10; // 10, 20, 30%

                const rateDecimal = ratePercent / 100;
                const amountAfterYears = principal * Math.pow((1 + rateDecimal), years);
                const withdrawalAmount = amountAfterYears * (withdrawalPercent / 100);
                const remainingAmount = amountAfterYears - withdrawalAmount;

                const problemText = `John invests $${principal} at an annual interest rate of ${ratePercent}% compounded annually. How much will he have after ${years} years (to the nearest cent)? If he then withdraws ${withdrawalPercent}% of the total at that time, how much remains (to the nearest cent)?`;
                const solutionStepsHTML = `
                    <p>Principal (P) = $${principal}, Rate (r) = ${ratePercent}% = ${rateDecimal}, Time (t) = ${years} years.</p>
                    <p><strong>Step 1: Calculate the amount after ${years} years using compound interest formula.</strong></p>
                    <p>Amount (A) = P(1 + r)<sup>t</sup></p>
                    <p>A = ${principal}(1 + ${rateDecimal})<sup>${years}</sup> = ${principal}(${1+rateDecimal})<sup>${years}</sup></p>
                    <p>A = ${principal} × ${formatDecimal(Math.pow(1+rateDecimal, years), 5)} = $${formatDecimal(amountAfterYears,2)}.</p>
                    <p><strong>Step 2: Calculate the withdrawal amount.</strong></p>
                    <p>Withdrawal = ${withdrawalPercent}% of $${formatDecimal(amountAfterYears,2)} = ${withdrawalPercent/100} × $${formatDecimal(amountAfterYears,2)} = $${formatDecimal(withdrawalAmount,2)}.</p>
                    <p><strong>Step 3: Calculate the remaining amount.</strong></p>
                    <p>Remaining = Amount after years - Withdrawal = $${formatDecimal(amountAfterYears,2)} - $${formatDecimal(withdrawalAmount,2)} = $${formatDecimal(remainingAmount,2)}.</p>
                    <p class="final-answer">Final Answer: After ${years} years ≈ $${formatDecimal(amountAfterYears,2)}, Remaining ≈ $${formatDecimal(remainingAmount,2)}</p>
                `;
                return { problemText, solutionStepsHTML };
            },
            
            // Problem 24: Clock Angle Problems
            function generateClockAngleProblem() {
                const hour = getRandomInt(1, 12);
                const minuteIntervals = [0, 5, 10, 15, 20, 25, 30, 35, 40, 45, 50, 55];
                const minute = minuteIntervals[getRandomInt(0, minuteIntervals.length - 1)];

                // Hour hand position: (hour % 12 + minute / 60) * 30 degrees
                // Minute hand position: minute * 6 degrees
                const hourAngle = (hour % 12 + minute / 60) * 30;
                const minuteAngle = minute * 6;

                let angleDiff = Math.abs(hourAngle - minuteAngle);
                if (angleDiff > 180) {
                    angleDiff = 360 - angleDiff;
                }

                const problemText = `What is the smaller angle between the hour hand and the minute hand of a clock at ${hour}:${minute < 10 ? '0' : ''}${minute} ${hour >= 1 && hour <= 5 || hour === 12 ? (minute === 0 && hour === 12 ? "Noon/Midnight" : "AM/PM") : (hour >= 6 && hour <= 11 ? "AM/PM" : "AM/PM")}?`;
                const solutionStepsHTML = `
                    <p>Time: ${hour}:${minute < 10 ? '0' : ''}${minute}.</p>
                    <p><strong>Step 1: Calculate the position of the minute hand.</strong></p>
                    <p>The minute hand moves 360° in 60 minutes, so 6° per minute.</p>
                    <p>Minute hand position = ${minute} × 6° = ${minuteAngle}° from the 12.</p>
                    <p><strong>Step 2: Calculate the position of the hour hand.</strong></p>
                    <p>The hour hand moves 360° in 12 hours (720 minutes), so 0.5° per minute, or 30° per hour.</p>
                    <p>Hour hand position from 12 = (${hour % 12} + ${formatFractionHTML(minute, 60)}) × 30°</p>
                    <p>= (${hour % 12} + ${formatDecimal(minute/60,2)}) × 30° = ${formatDecimal(hour % 12 + minute/60,2)} × 30° = ${formatDecimal(hourAngle,1)}° from the 12.</p>
                    <p><strong>Step 3: Calculate the absolute difference between the angles.</strong></p>
                    <p>Difference = |${formatDecimal(hourAngle,1)}° - ${minuteAngle}°| = |${formatDecimal(hourAngle - minuteAngle,1)}°| = ${formatDecimal(Math.abs(hourAngle - minuteAngle),1)}°.</p>
                    <p><strong>Step 4: Find the smaller angle.</strong></p>
                    <p>If difference > 180°, the smaller angle = 360° - difference.</p>
                    <p>Smaller angle = ${formatDecimal(angleDiff,1)}°.</p>
                    <p class="final-answer">Final Answer: ${formatDecimal(angleDiff,1)}°</p>
                `;
                return { problemText, solutionStepsHTML };
            }
        ];

        const allProblemGenerators = [...problemGenerators_Set1, ...problemGenerators_Set2];


        function generateNewTestData() {
            currentProblemsData = allProblemGenerators.map(generator => {
                try {
                    return generator();
                } catch (e) {
                    console.error("Error in problem generator:", e);
                    return { 
                        problemText: "Error generating this problem. Please try again.",
                        solutionStepsHTML: `<p>An error occurred: ${e.message}</p><p>Generator function: ${generator.name || 'anonymous'}</p>`
                    };
                }
            });
        }

        function displayProblems() {
            problemListContainer.innerHTML = ''; 
            showSolutionsBtn.textContent = 'Show Solutions';
            showSolutionsBtn.disabled = false;

            currentProblemsData.forEach((data, index) => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <span class="problem-number">${index + 1}.</span>
                    <div class="problem-text-container">${data.problemText}</div>
                    <span class="answer-space">Answer: ____________</span>
                    <div class="solution-steps" id="solution-${index + 1}">
                        ${data.solutionStepsHTML}
                    </div>
                `;
                problemListContainer.appendChild(listItem);
            });

            const solutions = document.querySelectorAll('.solution-steps');
            solutions.forEach(sol => sol.style.display = 'none');
            const problemItems = document.querySelectorAll('.problem-list > li');
            problemItems.forEach(item => item.classList.remove('solutions-shown'));
        }

        function handleGenerateTest() {
            generateNewTestData();
            displayProblems();
        }

        function showSolutions() {
            const solutions = document.querySelectorAll('.solution-steps');
            const problemItems = document.querySelectorAll('.problem-list > li');

            if (solutions.length === 0) return;

            let shouldShowAll = false;
            solutions.forEach(sol => {
                if (sol.style.display === 'none') {
                    shouldShowAll = true;
                }
            });

            if (shouldShowAll) {
                solutions.forEach(sol => sol.style.display = 'block');
                problemItems.forEach(item => item.classList.add('solutions-shown'));
                showSolutionsBtn.textContent = 'Solutions Shown';
                showSolutionsBtn.disabled = true; 
            }
        }

        generateTestBtn.addEventListener('click', handleGenerateTest);
        showSolutionsBtn.addEventListener('click', showSolutions);
        
        // Load initial set of problems on page load
        handleGenerateTest();

    </script>
</body>
</html>