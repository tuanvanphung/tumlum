<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order of Operations Practice</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .controls-container { 
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #f0f0f0; 
            border-radius: 5px;
        }
        .controls-container button {
            padding: 10px 20px;
            font-size: 1em;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px 10px; 
        }
        #generateProblemsButton { background-color: #007bff; }
        #generateProblemsButton:hover { background-color: #0056b3; }
        #showSolutionsButton { background-color: #28a745; } /* Renamed ID for clarity */
        #showSolutionsButton:hover { background-color: #218838; }
        #showSolutionsButton:disabled {
            background-color: #6c757d; /* Gray when disabled */
            cursor: not-allowed;
        }


        .problem-list {
            list-style-type: none;
            padding-left: 0;
        }
        .problem-list li {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            transition: color 0.3s ease-in-out; 
        }
        .problem-number {
            font-weight: bold;
            margin-right: 10px;
            font-size: 1.1em;
            transition: color 0.3s ease-in-out; 
        }
        .problem-expression {
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.2em;
            color: #555;
            display: block;
            margin-bottom: 10px;
            word-wrap: break-word; 
            transition: color 0.3s ease-in-out;
        }
        .answer-space {
            display: block;
            margin-top: 10px;
            font-style: italic;
            color: #777;
            transition: color 0.3s ease-in-out;
        }

        .problem-list li.solutions-shown .problem-expression,
        .problem-list li.solutions-shown .answer-space,
        .problem-list li.solutions-shown .problem-number { 
            color: #bbb !important; 
        }


        sup, sub {
            line-height: 0;
        }
        .fraction {
            display: inline-block;
            vertical-align: middle;
            text-align: center;
            margin: 0 0.2em;
            position: relative;
        }
        .fraction .numerator, .fraction .denominator {
            display: block;
            padding: 0 0.3em;
            line-height: 1.2;
        }
        .fraction .numerator {
            border-bottom: 1.5px solid black;
        }
        .fraction .fraction { 
            font-size: 0.9em; 
            margin: 0 0.1em;
        }
        .fraction .numerator .fraction, .fraction .denominator .fraction {
             padding: 0 0.1em;
        }
        .solution-steps {
            display: none; 
            margin-top: 15px;
            padding: 15px;
            background-color: #e9f5e9; 
            border: 1px dashed #5cb85c;
            border-radius: 4px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1.0em; 
            line-height: 1.5;
        }
        .solution-steps p {
            margin: 8px 0; 
            word-wrap: break-word;
        }
        .solution-steps .final-answer {
            font-weight: bold;
            color: #337ab7;
            margin-top:10px;
            padding-top:5px;
            border-top: 1px solid #ccc;
        }
        .highlight-op { 
            color: #d9534f;
            font-weight: bold;
            background-color: #f9e6e5; 
            padding: 0 2px;
            border-radius: 2px;
        }

        @media print {
            body { margin: 0.5in; }
            .controls-container { display: none; } 
            h1 { font-size: 18pt; }
            .problem-list li { page-break-inside: avoid; }
            .problem-list li.solutions-shown .problem-expression,
            .problem-list li.solutions-shown .answer-space,
            .problem-list li.solutions-shown .problem-number {
                 color: #555 !important; 
            }
            .solution-steps {
                background-color: #fff !important; 
                border: 1px solid #ccc !important;
            }
        }
    </style>
</head>
<body>

    <h1>Order of Operations Practice</h1>

    <div class="controls-container">
        <button id="generateProblemsButton">Generate New Problems</button>
        <button id="showSolutionsButton" style="display:none;">Show Solutions</button> <!-- Changed ID and text -->
    </div>

    <ol class="problem-list" id="problemListContainer">
        <!-- Problems will be dynamically inserted here -->
    </ol>

    <script>
        const problemListContainer = document.getElementById('problemListContainer');
        const generateBtn = document.getElementById('generateProblemsButton');
        const showSolutionsBtn = document.getElementById('showSolutionsButton'); // Changed variable name

        // --- Helper Functions (Same as previous good version) ---
        const MAX_INTERMEDIATE_VALUE = 9999; 

        function isValueTooLarge(frac) {
            if (!frac || typeof frac.num === 'undefined' || typeof frac.den === 'undefined') {
                return true; 
            }
            return Math.abs(frac.num) > MAX_INTERMEDIATE_VALUE || Math.abs(frac.den) > MAX_INTERMEDIATE_VALUE;
        }

        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }
        
        function formatFractionHTML(num, den, isResult = false) {
            if (typeof num === 'object' && num.isFraction) { 
                den = num.den;
                num = num.num;
            }
            if (den === 1) return `${num}`; 
            return `<span class="fraction"><span class="numerator">${num}</span><span class="denominator">${den}</span></span>`;
        }

        function formatNumber(n, isResultInStep = false, preferDecimalForOriginal = false) {
            if (!n) return 'Error(null/undef)'; 
            if (n.isFraction) {
                if (preferDecimalForOriginal && n.originalDecimalValue !== undefined) {
                    const simpleDecimalRegex = /^-?\d*\.\d{1,2}$/; 
                    if (simpleDecimalRegex.test(n.originalDecimalValue.toString())) {
                        return n.originalDecimalValue.toString();
                    }
                }
                if (n.den === 1 && !isResultInStep) return n.num.toString();
                return formatFractionHTML(n.num, n.den, isResultInStep);
            }
            return n && typeof n.value !== 'undefined' ? n.value.toString() : 'Error(no_val)';
        }

        function formatBaseForExponent(baseFraction, preferDecimal = false) {
            if (!baseFraction) return '(ErrorBase)';
            const formattedBase = formatNumber(baseFraction, false, preferDecimal);
            if (baseFraction.num < 0 || formattedBase.includes('<span class="fraction"') || (typeof baseFraction.originalDecimalValue === 'number' && formattedBase.includes('.'))) {
                return `(${formattedBase})`;
            }
            return formattedBase;
        }
        
        function simplifyFraction(num, den) {
            function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
            if (den === 0) {
                return { num: num > 0 ? 1 : (num < 0 ? -1 : 0), den: 0, isFraction: true, value: Infinity * Math.sign(num), error: "Div by zero" };
            }
            if (den < 0) { num = -num; den = -den; }
            const common = gcd(Math.abs(num), Math.abs(den));
            let simplifiedNum = num / common;
            let simplifiedDen = den / common;
            return { num: simplifiedNum, den: simplifiedDen, isFraction: true, value: simplifiedNum / simplifiedDen };
        }

        function toFraction(numInput) {
            if (typeof numInput === 'object' && numInput.isFraction) return numInput; 
            
            let num = Number(numInput);
            let originalDecimalValue = undefined;

            if (typeof numInput === 'string' && numInput.includes('.')) { 
                originalDecimalValue = parseFloat(numInput); 
            } else if (typeof numInput === 'number' && numInput % 1 !== 0) { 
                 originalDecimalValue = numInput;
            }

            if (Number.isNaN(num)) {
                return { num: 0, den: 1, isFraction: true, value: 0, error: "NaN input", originalDecimalValue };
            }

            if (num % 1 !== 0) { 
                let s = num.toString();
                if (s.includes('e')) { 
                    const parts = s.split('e');
                    const significand = parseFloat(parts[0]);
                    const exponent = parseInt(parts[1]);
                    const baseTenExponent = (s.includes('.') ? (s.split('.')[1].length - (parts[0].startsWith('-') ? 1: 0)) : 0); 
                    let numerator = significand * Math.pow(10, baseTenExponent);
                    let denominator = Math.pow(10, baseTenExponent);

                    if (exponent > 0) {
                        numerator *= Math.pow(10, exponent);
                    } else { 
                        denominator *= Math.pow(10, Math.abs(exponent));
                    }
                    return { ...simplifyFraction(Math.round(numerator), Math.round(denominator)), originalDecimalValue };
                }
                if (s.includes('.')) {
                    const decimalPlaces = s.split('.')[1].length;
                    const denominator = Math.pow(10, decimalPlaces);
                    const numerator = Math.round(num * denominator); 
                    return { ...simplifyFraction(numerator, denominator), originalDecimalValue };
                }
            }
            return { num: Math.round(num), den: 1, isFraction: true, value: Math.round(num), originalDecimalValue };
        }

        function addFrac(f1, f2) { return simplifyFraction(f1.num * f2.den + f2.num * f1.den, f1.den * f2.den); }
        function subFrac(f1, f2) { return simplifyFraction(f1.num * f2.den - f2.num * f1.den, f1.den * f2.den); }
        function mulFrac(f1, f2) { return simplifyFraction(f1.num * f2.num, f1.den * f2.den); }
        function divFrac(f1, f2) {
            if (f2.num === 0) {
                 return { num: Math.sign(f1.num), den: 0, isFraction: true, value: Infinity * Math.sign(f1.num), error: "Div by zero" };
            }
            return simplifyFraction(f1.num * f2.den, f1.den * f2.num);
        }
        function powFrac(base, exp) {
            if (base.num === 0 && exp < 0) {
                return { num: 1, den: 0, isFraction: true, value: Infinity, error: "0 to negative power" };
            }
            if (exp === 0) return toFraction(1);
            let result = toFraction(1);
            let absExp = Math.abs(exp);
            for (let i = 0; i < absExp; i++) { result = mulFrac(result, base); }
            if (exp < 0) {
                if (result.num === 0) {
                    return { num: 1, den: 0, isFraction: true, value: Infinity, error: "Intermediate 0 to negative power"};
                }
                result = divFrac(toFraction(1), result);
            }
            return result;
        }
        function absFrac(f) { return { num: Math.abs(f.num), den: f.den, isFraction: true, value: Math.abs(f.value), originalDecimalValue: f.originalDecimalValue !== undefined ? Math.abs(f.originalDecimalValue) : undefined }; }

        function generateOperand(options = {}) {
            const { min = -9, max = 9, forceFraction = false, nonZero = false, perfectSquare = false, simpleFractionDen = false, allowDecimal = true } = options;
            
            if (perfectSquare) {
                const bases = [1,2,3,4,5,6,7,8,9,10]; 
                const base = getRandomItem(bases);
                return toFraction(base * base);
            }

            const typeRoll = Math.random();

            if (allowDecimal && typeRoll < 0.30) { 
                let decimalPlaces = getRandomInt(1, 2);
                let val = getRandomInt(min*Math.pow(10,decimalPlaces), max*Math.pow(10,decimalPlaces)) / Math.pow(10, decimalPlaces);
                if (nonZero && val === 0) val = (Math.random() > 0.5 ? 0.1 : -0.1) * (Math.random() > 0.5 ? 1 : -1);
                return toFraction(val); 
            } else if (forceFraction || typeRoll < 0.65) { 
                let denMax = simpleFractionDen ? 5 : 9;
                let den = getRandomInt(2, denMax);
                let num = getRandomInt(1, den * 2); 
                if (nonZero && num === 0) num = 1;
                if (Math.random() < 0.5 && min < 0) num *= -1; 
                return simplifyFraction(num, den);
            } else { 
                let val = getRandomInt(min > 0 && nonZero ? 1 : min, max);
                if (nonZero && val === 0) val = (max > 1 || min < -1) ? (Math.random() > 0.5 ? 1 : -1) : 1;
                return toFraction(val);
            }
        }

        function generatePowerOperands() {
            let base, exp;
            const expType = Math.random();
            if (expType < 0.35) { 
                exp = getRandomInt(-3, -1);
                base = generateOperand({min: -5, max: 5, nonZero: true, simpleFractionDen: true, allowDecimal: Math.random() < 0.3 }); 
            } else if (expType < 0.55) { 
                exp = 0;
                base = generateOperand({min: -7, max: 7, allowDecimal: true}); 
            } else { 
                exp = getRandomInt(1, 3);
                base = generateOperand({min: -7, max: 7, allowDecimal: true});
            }
            return { base, exp };
        }
        
        // --- Problem and Solution Generation (Same as previous good version) ---
        function generateProblemAndSolution() {
            let problemString = '';
            let steps = []; 
            let finalAnswer;

            function checkIntermediate(value, stepDescription = "Intermediate") {
                if (!value) { 
                     throw new Error(`${stepDescription} resulted in undefined value.`);
                }
                if (isValueTooLarge(value)) {
                    throw new Error(`${stepDescription} value too large: num=${value.num}, den=${value.den}`);
                }
                if (value.error) { 
                    throw new Error(`${stepDescription} error: ${value.error}`);
                }
                return value;
            }


            const problemTemplates = [
                function template1() { 
                    const A = generateOperand({min: -5, max: 5, allowDecimal: true});
                    const B = generateOperand({min: 1, max: 10, allowDecimal: true});
                    const C = generateOperand({min: -5, max: (B.value || 0) -1, allowDecimal: true }); 
                    const exp1 = generatePowerOperands().exp; 
                    const D_frac = generateOperand({forceFraction: true, nonZero: true, simpleFractionDen: true, allowDecimal: false});
                    const E_sqrt_base_val = getRandomInt(2,8); 
                    const E_sqrt_val = toFraction(E_sqrt_base_val * E_sqrt_base_val);

                    steps.push(`1. Innermost parentheses: <span class="highlight-op">${formatNumber(B, false, true)} - ${formatNumber(C, false, true)}</span>`);
                    let val_BC = subFrac(B, C); 
                    val_BC = checkIntermediate(val_BC, "Step 1 (B-C)");
                    steps.push(`   = ${formatNumber(val_BC, true)}`);

                    steps.push(`2. Exponent: <span class="highlight-op">${formatBaseForExponent(val_BC, true)}<sup>${exp1}</sup></span>`);
                    let val_BC_exp = powFrac(val_BC, exp1); 
                    val_BC_exp = checkIntermediate(val_BC_exp, "Step 2 (val_BC)^exp1");
                    steps.push(`   = ${formatNumber(val_BC_exp, true)}`);

                    steps.push(`3. Addition in brackets: <span class="highlight-op">${formatNumber(A, false, true)} + ${formatNumber(val_BC_exp)}</span>`);
                    let val_A_BC_exp = addFrac(A, val_BC_exp);
                    val_A_BC_exp = checkIntermediate(val_A_BC_exp, "Step 3 A+(val_BC_exp)");
                    steps.push(`   = ${formatNumber(val_A_BC_exp, true)}`);
                    
                    steps.push(`4. Multiplication in braces: <span class="highlight-op">${formatNumber(val_A_BC_exp)} * ${formatNumber(D_frac, false, true)}</span>`);
                    let val_braces = mulFrac(val_A_BC_exp, D_frac);
                    val_braces = checkIntermediate(val_braces, "Step 4 (val_A_BC_exp)*D_frac");
                    steps.push(`   = ${formatNumber(val_braces, true)}`);

                    steps.push(`5. Square root: <span class="highlight-op">&radic;${E_sqrt_val.num}</span>`);
                    const val_E = toFraction(E_sqrt_base_val); 
                    steps.push(`   = ${formatNumber(val_E, true)}`);
                    
                    steps.push(`6. Final subtraction: <span class="highlight-op">${formatNumber(val_braces)} - ${formatNumber(val_E)}</span>`);
                    finalAnswer = subFrac(val_braces, val_E);
                    finalAnswer = checkIntermediate(finalAnswer, "Final Answer Template 1");
                    steps.push(`   = ${formatNumber(finalAnswer, true)}`);

                    problemString = `{[${formatNumber(A, false, true)} + (${formatNumber(B, false, true)} - ${formatNumber(C, false, true)})<sup>${exp1}</sup>] * ${formatNumber(D_frac, false, true)}} - &radic;${E_sqrt_val.num}`;
                },
                function template2() { 
                    const A_frac = generateOperand({forceFraction: true, nonZero: true, allowDecimal: false}); 
                    const B_int = generateOperand({min: 1, max: 5, nonZero: true, allowDecimal: false}); 
                    const C = generateOperand({min: -4, max: 4, allowDecimal: true});
                    const D_neg = generateOperand({min: -7, max: -1, allowDecimal: true});
                    const {base: E_base, exp: E_exp} = generatePowerOperands(); 

                    steps.push(`1. Division inside absolute value: <span class="highlight-op">${formatNumber(A_frac, false, true)} &divide; ${formatNumber(B_int, false, true)}</span>`);
                    let val_div_AB = divFrac(A_frac, B_int);
                    val_div_AB = checkIntermediate(val_div_AB, "Step 1 A_frac/B_int");
                    steps.push(`   = ${formatNumber(val_div_AB, true)}`);

                    steps.push(`2. Subtraction inside absolute value: <span class="highlight-op">${formatNumber(val_div_AB)} - ${formatNumber(C, false, true)}</span>`);
                    let val_inside_abs = subFrac(val_div_AB, C);
                    val_inside_abs = checkIntermediate(val_inside_abs, "Step 2 (val_div_AB)-C");
                    steps.push(`   = ${formatNumber(val_inside_abs, true)}`);

                    steps.push(`3. Absolute value: <span class="highlight-op">|${formatNumber(val_inside_abs)}|</span>`);
                    const val_abs = absFrac(val_inside_abs); 
                    steps.push(`   = ${formatNumber(val_abs, true)}`);

                    steps.push(`4. Exponent in parentheses: <span class="highlight-op">${formatBaseForExponent(E_base, true)}<sup>${E_exp}</sup></span>`);
                    let val_E_pow = powFrac(E_base, E_exp);
                    val_E_pow = checkIntermediate(val_E_pow, "Step 4 E_base^E_exp");
                    steps.push(`   = ${formatNumber(val_E_pow, true)}`);

                    steps.push(`5. Addition in parentheses: <span class="highlight-op">${formatNumber(D_neg, false, true)} + ${formatNumber(val_E_pow)}</span>`);
                    let val_paren_DE = addFrac(D_neg, val_E_pow);
                    val_paren_DE = checkIntermediate(val_paren_DE, "Step 5 D_neg+val_E_pow");
                    steps.push(`   = ${formatNumber(val_paren_DE, true)}`);

                    steps.push(`6. Final multiplication: <span class="highlight-op">${formatNumber(val_abs)} * ${formatNumber(val_paren_DE)}</span>`);
                    finalAnswer = mulFrac(val_abs, val_paren_DE);
                    finalAnswer = checkIntermediate(finalAnswer, "Final Answer Template 2");
                    steps.push(`   = ${formatNumber(finalAnswer, true)}`);

                    problemString = `| ${formatNumber(A_frac, false, true)} &divide; ${formatNumber(B_int, false, true)} - ${formatNumber(C, false, true)} | * (${formatNumber(D_neg, false, true)} + ${formatBaseForExponent(E_base, true)}<sup>${E_exp}</sup>)`;
                },
                function template3() { 
                    const {base: A, exp: exp_A} = generatePowerOperands();
                    const B_frac = generateOperand({forceFraction:true, simpleFractionDen:true, allowDecimal: false}); 
                    const C_frac = generateOperand({forceFraction:true, simpleFractionDen:true, nonZero: true, allowDecimal: false}); 
                    const {base: D, exp: exp_D} = generatePowerOperands();
                    const E_neg = generateOperand({min:-4, max:-1, allowDecimal: true});

                    steps.push(`1. Numerator exponent: <span class="highlight-op">${formatBaseForExponent(A, true)}<sup>${exp_A}</sup></span>`);
                    let val_A_exp = powFrac(A, exp_A);
                    val_A_exp = checkIntermediate(val_A_exp, "T3S1 A^exp_A");
                    steps.push(`   = ${formatNumber(val_A_exp, true)}`);

                    steps.push(`2. Numerator addition: <span class="highlight-op">${formatNumber(val_A_exp)} + ${formatNumber(B_frac, false, true)}</span>`);
                    let val_Numerator = addFrac(val_A_exp, B_frac);
                    val_Numerator = checkIntermediate(val_Numerator, "T3S2 NumAdd");
                    steps.push(`   = ${formatNumber(val_Numerator, true)}`);

                    steps.push(`3. Denominator exponent: <span class="highlight-op">${formatBaseForExponent(D, true)}<sup>${exp_D}</sup></span>`);
                    let val_D_exp = powFrac(D, exp_D);
                    val_D_exp = checkIntermediate(val_D_exp, "T3S3 D^exp_D");
                    steps.push(`   = ${formatNumber(val_D_exp, true)}`);

                    steps.push(`4. Denominator subtraction: <span class="highlight-op">${formatNumber(C_frac, false, true)} - ${formatNumber(val_D_exp)}</span>`);
                    let val_Denominator = subFrac(C_frac, val_D_exp);
                    if (val_Denominator.num === 0) { 
                        val_Denominator = addFrac(val_Denominator, toFraction(Math.random() > 0.5 ? 0.1 : -0.1)); 
                        steps.push(`   (Adjusted to avoid division by zero) = ${formatNumber(val_Denominator, true)}`);
                    } else {
                        steps.push(`   = ${formatNumber(val_Denominator, true)}`);
                    }
                    val_Denominator = checkIntermediate(val_Denominator, "T3S4 DenSub");


                    steps.push(`5. Division of main fraction: <span class="highlight-op">${formatNumber(val_Numerator)} &divide; ${formatNumber(val_Denominator)}</span>`);
                    let val_MainFrac = divFrac(val_Numerator, val_Denominator);
                    val_MainFrac = checkIntermediate(val_MainFrac, "T3S5 MainDiv");
                    steps.push(`   = ${formatNumber(val_MainFrac, true)}`);
                    
                    steps.push(`6. Final multiplication: <span class="highlight-op">${formatNumber(val_MainFrac)} * ${formatNumber(E_neg, false, true)}</span>`);
                    finalAnswer = mulFrac(val_MainFrac, E_neg);
                    finalAnswer = checkIntermediate(finalAnswer, "T3S6 FinalMul");
                    steps.push(`   = ${formatNumber(finalAnswer, true)}`);
                    
                    problemString = `(<span class="fraction"><span class="numerator">${formatBaseForExponent(A, true)}<sup>${exp_A}</sup> + ${formatNumber(B_frac, false, true)}</span><span class="denominator">${formatNumber(C_frac, false, true)} - ${formatBaseForExponent(D, true)}<sup>${exp_D}</sup></span></span>) * ${formatNumber(E_neg, false, true)}`;
                },
                function template4() { 
                    const a = generateOperand({min: -10, max: 10, allowDecimal: true});
                    const b = generateOperand({min: -5, max: 5, nonZero: true, allowDecimal: true});
                    const c = generateOperand({min: 1, max: 10, allowDecimal: true});
                    const {base: d_base, exp: d_exp} = generatePowerOperands();
                    const op1 = getRandomItem(['+', '-']);
                    const op2 = getRandomItem(['*', '/']); 
                    const op3 = getRandomItem(['+', '-']);

                    steps.push(`1. Innermost exponent: <span class="highlight-op">${formatBaseForExponent(d_base, true)}<sup>${d_exp}</sup></span>`);
                    let val_d_pow = powFrac(d_base, d_exp);
                    val_d_pow = checkIntermediate(val_d_pow, "T4S1 d_base^d_exp");
                    steps.push(`   = ${formatNumber(val_d_pow, true)}`);

                    let val_c_op2_dpow;
                    let step2OpString = `${formatNumber(c, false, true)} ${op2 === '/' ? '&divide;' : op2} ${formatNumber(val_d_pow)}`;
                    steps.push(`2. Innermost parentheses operation: <span class="highlight-op">${step2OpString}</span>`);
                    if (op2 === '*') {
                        val_c_op2_dpow = mulFrac(c, val_d_pow);
                    } else { 
                        let divisor_safe = val_d_pow;
                        if (val_d_pow.num === 0) divisor_safe = toFraction(1); 
                        val_c_op2_dpow = divFrac(c, divisor_safe);
                        if(val_d_pow.num === 0) step2OpString = `${formatNumber(c, false, true)} ${op2 === '/' ? '&divide;' : op2} ${formatNumber(divisor_safe)} (original divisor was 0)`;
                    }
                    val_c_op2_dpow = checkIntermediate(val_c_op2_dpow, "T4S2 c_op2_dpow");
                    steps.push(`   = ${formatNumber(val_c_op2_dpow, true)}`);

                    let step3OpString = `${formatNumber(b, false, true)} ${op1} ${formatNumber(val_c_op2_dpow)}`;
                    steps.push(`3. Brackets: <span class="highlight-op">${step3OpString}</span>`);
                    let val_bracket;
                    if (op1 === '+') val_bracket = addFrac(b, val_c_op2_dpow);
                    else val_bracket = subFrac(b, val_c_op2_dpow);
                    val_bracket = checkIntermediate(val_bracket, "T4S3 bracket_val");
                    steps.push(`   = ${formatNumber(val_bracket, true)}`);

                    let step4OpString = `${formatNumber(a, false, true)} ${op3} ${formatNumber(val_bracket)}`;
                    steps.push(`4. Braces/Final operation: <span class="highlight-op">${step4OpString}</span>`);
                    if (op3 === '+') finalAnswer = addFrac(a, val_bracket);
                    else finalAnswer = subFrac(a, val_bracket);
                    finalAnswer = checkIntermediate(finalAnswer, "T4S4 Final");
                    steps.push(`   = ${formatNumber(finalAnswer, true)}`);
                    
                    problemString = `{${formatNumber(a, false, true)} ${op3} [${formatNumber(b, false, true)} ${op1} (${formatNumber(c, false, true)} ${op2 === '/' ? '&divide;' : op2} ${formatBaseForExponent(d_base, true)}<sup>${d_exp}</sup>)]}`;
                },
                function template5() {
                    const A = generateOperand({min: -5, max: 5, nonZero: true, allowDecimal: true});
                    const {base: B, exp: exp1} = generatePowerOperands();
                    const C_sqrt_base = getRandomInt(1, 7); 
                    const C_sqrt_val = toFraction(C_sqrt_base * C_sqrt_base);

                    const D_frac = generateOperand({forceFraction: true, nonZero: true, simpleFractionDen: true, allowDecimal: false}); 
                    const E = generateOperand({min: -5, max: 5, allowDecimal: true});
                    const F = generateOperand({min: -5, max: 5, allowDecimal: true});
                    let exp2_obj = generatePowerOperands();
                    let exp2 = exp2_obj.exp;
                    let val_EF_test = subFrac(E,F);
                    if (val_EF_test.num === 0 && exp2 < 0) {
                        exp2 = getRandomInt(0,2); 
                    }

                    steps.push(`1. Exponent in absolute value (numerator): <span class="highlight-op">${formatBaseForExponent(B, true)}<sup>${exp1}</sup></span>`);
                    let val_B_exp = powFrac(B, exp1);
                    val_B_exp = checkIntermediate(val_B_exp, "T5S1 B^exp1");
                    steps.push(`   = ${formatNumber(val_B_exp, true)}`);

                    steps.push(`2. Multiplication in absolute value (numerator): <span class="highlight-op">${formatNumber(A, false, true)} * ${formatNumber(val_B_exp)}</span>`);
                    let val_AB_exp = mulFrac(A, val_B_exp);
                    val_AB_exp = checkIntermediate(val_AB_exp, "T5S2 A*B_exp");
                    steps.push(`   = ${formatNumber(val_AB_exp, true)}`);

                    steps.push(`3. Square root (numerator): <span class="highlight-op">&radic;${C_sqrt_val.num}</span>`);
                    const val_C = toFraction(C_sqrt_base);
                    steps.push(`   = ${formatNumber(val_C, true)}`);
                    
                    steps.push(`4. Subtraction for absolute value (numerator): <span class="highlight-op">${formatNumber(val_AB_exp)} - ${formatNumber(val_C)}</span>`);
                    let val_inside_abs_num = subFrac(val_AB_exp, val_C);
                    val_inside_abs_num = checkIntermediate(val_inside_abs_num, "T5S4 inside_abs_num");
                    steps.push(`   = ${formatNumber(val_inside_abs_num, true)}`);

                    steps.push(`5. Absolute value (numerator): <span class="highlight-op">|${formatNumber(val_inside_abs_num)}|</span>`);
                    const val_Numerator = absFrac(val_inside_abs_num);
                    steps.push(`   = ${formatNumber(val_Numerator, true)}`);

                    steps.push(`6. Parentheses in denominator: <span class="highlight-op">${formatNumber(E, false, true)} - ${formatNumber(F, false, true)}</span>`);
                    let val_EF = subFrac(E, F);
                    val_EF = checkIntermediate(val_EF, "T5S6 E-F");
                    steps.push(`   = ${formatNumber(val_EF, true)}`);

                    steps.push(`7. Exponent in denominator: <span class="highlight-op">${formatBaseForExponent(val_EF, true)}<sup>${exp2}</sup></span>`);
                    let val_EF_exp = powFrac(val_EF, exp2);
                    val_EF_exp = checkIntermediate(val_EF_exp, "T5S7 (E-F)^exp2");
                    steps.push(`   = ${formatNumber(val_EF_exp, true)}`);

                    steps.push(`8. Addition in denominator: <span class="highlight-op">${formatNumber(D_frac, false, true)} + ${formatNumber(val_EF_exp)}</span>`);
                    let val_Denominator = addFrac(D_frac, val_EF_exp);
                     if (val_Denominator.num === 0) { 
                        val_Denominator = addFrac(val_Denominator, toFraction(Math.random() > 0.5 ? 0.01 : -0.01)); 
                        steps.push(`   (Adjusted to avoid division by zero) = ${formatNumber(val_Denominator, true)}`);
                    } else {
                        steps.push(`   = ${formatNumber(val_Denominator, true)}`);
                    }
                    val_Denominator = checkIntermediate(val_Denominator, "T5S8 Denominator");


                    steps.push(`9. Final division: <span class="highlight-op">${formatNumber(val_Numerator)} &divide; ${formatNumber(val_Denominator)}</span>`);
                    finalAnswer = divFrac(val_Numerator, val_Denominator);
                    finalAnswer = checkIntermediate(finalAnswer, "T5S9 Final");
                    steps.push(`   = ${formatNumber(finalAnswer, true)}`);

                    problemString = `<span class="fraction"><span class="numerator">|${formatNumber(A, false, true)} * ${formatBaseForExponent(B, true)}<sup>${exp1}</sup> - &radic;${C_sqrt_val.num}|</span><span class="denominator">{${formatNumber(D_frac, false, true)} + (${formatNumber(E, false, true)} - ${formatNumber(F, false, true)})<sup>${exp2}</sup>}</span></span>`;
                },
                function template6() {
                    const G_neg = generateOperand({min: -10, max: -1, allowDecimal: true});
                    const H = generateOperand({min: -5, max: 5, allowDecimal: true});
                    const I_frac = generateOperand({forceFraction: true, nonZero: true, allowDecimal: false}); 
                    const J = generateOperand({min: -7, max: 7, allowDecimal: true});
                    const K_val_for_abs = generateOperand({min: -9, max: 9, allowDecimal: true}); 
                    const exp_neg = getRandomInt(-2, -1); 

                    steps.push(`1. Innermost absolute value: <span class="highlight-op">|${formatNumber(K_val_for_abs, false, true)}|</span>`);
                    const val_K_abs = absFrac(K_val_for_abs);
                    steps.push(`   = ${formatNumber(val_K_abs, true)}`);

                    steps.push(`2. Subtraction in parentheses (divisor): <span class="highlight-op">${formatNumber(J, false, true)} - ${formatNumber(val_K_abs)}</span>`);
                    let val_divisor = subFrac(J, val_K_abs);
                    if (val_divisor.num === 0) {
                        val_divisor = toFraction(1); 
                        steps.push(`   (Adjusted to avoid division by zero) = ${formatNumber(val_divisor, true)}`);
                    } else {
                        steps.push(`   = ${formatNumber(val_divisor, true)}`);
                    }
                    val_divisor = checkIntermediate(val_divisor, "T6S2 Divisor");


                    steps.push(`3. Division inside brackets: <span class="highlight-op">${formatNumber(I_frac, false, true)} &divide; ${formatNumber(val_divisor)}</span>`);
                    let val_division_in_bracket = divFrac(I_frac, val_divisor);
                    val_division_in_bracket = checkIntermediate(val_division_in_bracket, "T6S3 DivisionInBracket");
                    steps.push(`   = ${formatNumber(val_division_in_bracket, true)}`);

                    steps.push(`4. Negative exponent on bracket result: <span class="highlight-op">${formatBaseForExponent(val_division_in_bracket, true)}<sup>${exp_neg}</sup></span>`);
                    let val_bracket_exp = powFrac(val_division_in_bracket, exp_neg);
                    val_bracket_exp = checkIntermediate(val_bracket_exp, "T6S4 Bracket^exp");
                    steps.push(`   = ${formatNumber(val_bracket_exp, true)}`);

                    steps.push(`5. Addition inside braces: <span class="highlight-op">${formatNumber(H, false, true)} + ${formatNumber(val_bracket_exp)}</span>`);
                    let val_braces = addFrac(H, val_bracket_exp);
                    val_braces = checkIntermediate(val_braces, "T6S5 BracesAdd");
                    steps.push(`   = ${formatNumber(val_braces, true)}`);

                    steps.push(`6. Final subtraction: <span class="highlight-op">${formatNumber(G_neg, false, true)} - ${formatNumber(val_braces)}</span>`);
                    finalAnswer = subFrac(G_neg, val_braces);
                    finalAnswer = checkIntermediate(finalAnswer, "T6S6 FinalSub");
                    steps.push(`   = ${formatNumber(finalAnswer, true)}`);

                    problemString = `${formatNumber(G_neg, false, true)} - {${formatNumber(H, false, true)} + [${formatNumber(I_frac, false, true)} &divide; (${formatNumber(J, false, true)} - |${formatNumber(K_val_for_abs, false, true)}|)]<sup>${exp_neg}</sup>}`;
                }
            ];
            
            try {
                const selectedTemplate = getRandomItem(problemTemplates);
                selectedTemplate(); 

                let stepsHTMLContent = '<p><strong>Step-by-step solution:</strong></p>';
                steps.forEach(step => stepsHTMLContent += `<p>${step}</p>`); 
                stepsHTMLContent += `<p class="final-answer">Final Answer: ${formatNumber(finalAnswer, true)}</p>`;
                
                return { problemHTML: problemString, stepsHTML: stepsHTMLContent, answer: finalAnswer };

            } catch (e) { 
                console.warn("Error during problem generation (intermediate value or operation error):", e.message, "Regenerating.");
                return generateProblemAndSolution(); 
            }
        }

        function displayProblems() {
            problemListContainer.innerHTML = ''; 
            
            showSolutionsBtn.style.display = 'inline-block'; 
            showSolutionsBtn.textContent = 'Show Solutions'; 
            showSolutionsBtn.disabled = false; 


            const existingProblemItems = document.querySelectorAll('.problem-list > li');
            existingProblemItems.forEach(item => item.classList.remove('solutions-shown'));


            let generatedCount = 0;
            let attempts = 0;
            const maxAttempts = 100; 

            while(generatedCount < 15 && attempts < maxAttempts) {
                attempts++;
                let generated;
                try {
                     generated = generateProblemAndSolution();
                } catch (e) { 
                    console.error("Outer catch for generateProblemAndSolution:", e.message);
                    generated = null; 
                }

                 if (!generated || generated.answer === undefined || (generated.answer && generated.answer.error) ) {
                    console.warn(`Attempt ${attempts}: Skipping problematic generation or error:`, generated ? (generated.answer ? generated.answer.error : "answer undefined") : "undefined generated object");
                    continue; 
                }
                const { problemHTML, stepsHTML, answer } = generated;

                const listItem = document.createElement('li'); 
                listItem.innerHTML = `
                    <span class="problem-number">${generatedCount + 1}.</span>
                    <span class="problem-expression">${problemHTML}</span>
                    <span class="answer-space">Answer: ____________</span>
                    <div class="solution-steps" id="solution-${generatedCount+1}">
                        ${stepsHTML}
                    </div>
                `;
                problemListContainer.appendChild(listItem);
                generatedCount++;
            }
            if (generatedCount < 15) {
                console.error(`Only generated ${generatedCount} valid problems after ${maxAttempts} attempts.`);
                 const listItem = document.createElement('li');
                 listItem.innerHTML = `<span class="problem-number">!</span><span class="problem-expression">Could not generate full set of valid problems. Please try generating again. Some problems might have issues.</span>`;
                 problemListContainer.appendChild(listItem);
            }

            const solutions = document.querySelectorAll('.solution-steps');
            solutions.forEach(sol => sol.style.display = 'none'); 
        }

        function showSolutions() { // Renamed from toggleSolutions
            const solutions = document.querySelectorAll('.solution-steps');
            const problemItems = document.querySelectorAll('.problem-list > li'); 
            
            if (solutions.length === 0) return;

            solutions.forEach(sol => sol.style.display = 'block');
            problemItems.forEach(item => item.classList.add('solutions-shown')); 
            
            showSolutionsBtn.textContent = 'Solutions Shown';
            showSolutionsBtn.disabled = true; // Disable after showing
        }

        generateBtn.addEventListener('click', displayProblems);
        showSolutionsBtn.addEventListener('click', showSolutions); // Updated event listener
        displayProblems();

    </script>
</body>
</html>